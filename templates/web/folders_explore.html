{% extends theme("web/root.html") %}
{% block content %}

    <div class="dropdown-menu dropdown-menu-sm" id="context-menu">
        <a id="menu_open" class="dropdown-item content_item bi bi-eye fs4" href="#">&nbsp;Open</a>
        <a id="menu_download" class="dropdown-item content_item bi bi-download" href="#">&nbsp;Download</a>
        <a id="menu_favorites" class="dropdown-item content_item bi bi-star" href="#" onclick="favorite_listing();">&nbsp;Favorite</a>
        <hr/>
        <a class="dropdown-item content_item bi bi-pencil rename" href="#" onclick="context_rename();">&nbsp;Rename</a>
        <a class="dropdown-item content_item bi bi-scissors" href="#" onclick="context_cut();">&nbsp;Cut</a>
        <a class="dropdown-item content_item bi bi-copy" href="#" onclick="context_copy();">&nbsp;Copy</a>
        <a class="dropdown-item content_item bi bi-clipboard" href="#" onclick="context_paste();">&nbsp;Paste</a>
        <hr/>
        <a class="dropdown-item content_item bi bi-trash3" href="#" data-bs-toggle="modal"
           data-bs-target="#deleteConfirmModal">&nbsp;Delete</a>
    </div>

    <!-- Just Paste, for the drop area -->
    <div id="dropzone-context-menu" class="dropdown-menu" style="position: absolute; display: none; z-index: 9999;">
        <a class="dropdown-item content_item bi bi-clipboard" href="#" onclick="context_paste();">&nbsp;Paste</a>
    </div>

    <div class="align-items-center p-3">
        <div class="row align-items-start">
            <div class="col-md-6 col-lg-5">
                <div class="card bg-light" id="explore-card">
                    <nav class="card-header navbar navbar-expand-xl navbar-dark bg-dark">
                        <div class="container-fluid">
                            <div class="btn-group" role="group" aria-label="folder_functions">
                                <div id="folder_toolbar">
                                    <button id="toggle_select_mode" type="button" class="btn text-secondary">
                                        <i class="bi bi-check-square"></i> Select
                                    </button>
                                    <button type="button" class="btn text-secondary"><i>New</i></button>
                                    <button id="new_1" type="button" class="btn text-white toggle_show hoverover"
                                            opacity=0.15 style="opacity: 0.15" new_file_class="bi-folder"
                                            new_file_type="folder" data-bs-toggle="tooltip" data-bs-title="Folder"
                                            data-bs-placement="bottom"><i class="bi bi-folder"></i></button>
                                    <button id="new_2" type="button" class="btn text-white toggle_show hoverover"
                                            opacity=0.15 style="opacity: 0.15" new_file_class="bi-journal-arrow-down"
                                            new_file_type="task" data-bs-toggle="tooltip" data-bs-title="Task"
                                            data-bs-placement="bottom"><i class="bi bi-journal-arrow-down"></i></button>
                                    <button id="new_3" type="button" class="btn text-white toggle_show hoverover"
                                            opacity=0.15 style="opacity: 0.15"
                                            new_file_class="bi-file-earmark-spreadsheet" new_file_type="slate"
                                            data-bs-toggle="tooltip" data-bs-title="Slate (Interactive Dashboard)"
                                            data-bs-placement="bottom"><i class="bi bi-file-earmark-spreadsheet"></i>
                                    </button>
                                    <button id="new_4" type="button" class="btn text-white toggle_show hoverover"
                                            opacity=0.15 style="opacity: 0.15" new_file_class="bi-blockquote-left"
                                            new_file_type="markdown" data-bs-toggle="tooltip"
                                            data-bs-title="Markdown File (Help Content)" data-bs-placement="bottom"><i
                                            class="bi bi-blockquote-left"></i></button>
                                    <button id="new_5" type="button" class="btn text-white toggle_show hoverover"
                                            opacity=0.15 style="opacity: 0.15" new_file_class="bi-chat-left-text"
                                            new_file_type="conversation" data-bs-toggle="tooltip"
                                            data-bs-title="Conversation" data-bs-placement="bottom"><i
                                            class="bi bi-chat-left-text"></i></button>
                                </div>
                            </div>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#navbarFolder" aria-controls="navbarFolder" aria-expanded="false"
                                    aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="navbarFolder">
                                <ul class="navbar-nav ma-2 mb-lg-0">
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle hoverover" opacity=0.25 href="#"
                                           id="navbarDropdown" role="button" data-bs-toggle="dropdown"
                                           aria-expanded="false">
                                            all...
                                        </a>
                                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                            <a class="dropdown-item toggle_show" new_file_type="folder"
                                               new_file_class="bi-folder" href="#"><i class="bi bi-folder"></i>
                                                Folder</a>
                                            <a class="dropdown-item toggle_show" new_file_type="field"
                                               new_file_class="bi-menu-app" href="#"><i class="bi bi-menu-app"></i>
                                                Field</a>
                                            <a class="dropdown-item toggle_show" new_file_type="task"
                                               new_file_class="bi-journal-arrow-down" href="#"><i
                                                    class="bi bi-journal-arrow-down"></i> Task</a>
                                            <a class="dropdown-item toggle_show" new_file_type="slate"
                                               new_file_class="bi-file-earmark-spreadsheet" href="#"><i
                                                    class="bi bi-file-earmark-spreadsheet"></i> Slate</a>
                                            <a class="dropdown-item toggle_show" new_file_type="markdown"
                                               new_file_class="bi-blockquote-left" href="#"><i
                                                    class="bi bi-blockquote-left"></i> Markdown</a>
                                            <a class="dropdown-item toggle_show" new_file_type="conversation"
                                               new_file_class="bi-chat-left-text" href="#"><i
                                                    class="bi bi-chat-left-text"></i> Conversation</a>
                                            <a class="dropdown-item toggle_show" new_file_type="source"
                                               new_file_class="bi-database" href="#"><i class="bi bi-database"></i>
                                                Source</a>
                                            <a class="dropdown-item toggle_show" new_file_type="table"
                                               new_file_class="bi-table" href="#"><i class="bi bi-table"></i> Table</a>
                                            <a class="dropdown-item toggle_show" new_file_type="environment"
                                               new_file_class="bi-eye" href="#"><i class="bi bi-eye"></i>
                                                Environment</a>
                                            <a class="dropdown-item toggle_show" new_file_type="config"
                                               new_file_class="bi-sliders" href="#"><i class="bi bi-sliders"></i> Config</a>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                    <div class="card-body">
                        <div class="list-group" style="width: 100%">
                            <div id="toggle_target" name="toggle_target"
                                 class="list-group-item list-group-item-action container-fluid toggle_target p-3"
                                 style="display: none;">
                                <div class="row">
                                    <div class="col">
                                        <div class="row row-cols-auto justify-content-center align-items-center"
                                             style="width:100%;">
                                            <i id="new_item" class="bi bi-folder position-relative new_item"
                                               style="font-size: 1.8rem;">
                                                <div class="rounded-pill badge-notification position-absolute translate-middle"
                                                     style="font-size: 0.86em; left: 80%!important;top: 20%!important;">
                                                    <i class="bi bi-plus-circle-dotted"></i>
                                                </div>
                                            </i>
                                            <div class="col-10">
                                                <form id="new_content_form" class="col">
                                                    <div class="btn-group d-flex" role="group"
                                                         aria-label="task_functions" style="width: 100%;">
                                                        <input id="new_content" name="new_content" type="text"
                                                               value="Untitled" class="form-control"
                                                               maxlength="64" style="width: 100%;">
                                                        <input id="new_content_type" name="new_content_type"
                                                               type="hidden" value=""
                                                               class="form-control new_content_type"
                                                               style="width: 100%;">
                                                        <button type="submit" class="btn btn-c2-secondary"><i
                                                                class="bi bi-floppy"></i></button>
                                                        <button type="button" class="btn btn-c2-secondary toggle_hide">
                                                            <i
                                                                    class="bi bi-x fs-4"></i></button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% for folder in folders | sortnicely %}
                                <div class="favorites-div folder list-group-item list-group-item-action d-flex">
                                    <a href="{{ url_for("clarama_content.content_get",mode='explore',filename=local_url + folder) }}"
                                       file_div="folder_{{ loop.index }}"
                                       listing_file="{{ folder }}"
                                       listing_filepath="{{ local_url + folder }}"
                                       listing_fullpath="{{ url_for('clarama_content.content_get',mode='explore', filename=local_url + folder) }}"
                                       listing_icon="bi-folder-fill"
                                       class="container-fluid listing text-black p-0"
                                       style="text-decoration:none"
                                       draggable="true"
                                    >
                                        <div class="row">
                                            <div class="col">
                                                <div class="row row-cols-auto align-items-center" style="width: 100%;">
                                                    <input type="checkbox"
                                                           class="multi-select-checkbox clarama-checkbox form-check-input d-none">
                                                    <i class="bi bi-folder-fill position-relative col pe-0"
                                                       style="font-size: 1.6rem;">
                                                        <!--<div class="clarama-embedded rounded-pill badge-notification position-absolute translate-middle"
                                              style="font-size: 0.6em; left: 80%!important;top: 20%!important;"
                                              url="{{ url_for("clarama_web_git.git_versioning",mode='explore',filetype='folder',filename=local_url + folder) }}">
                                        </div>--></i>
                                                    <div id="folder_{{ loop.index }}"
                                                         class="col d-flex align-items-center listing_div">{{ folder }}</div>
                                                </div>
                                            </div>
                                            <!--<i class="col col-sm-1 bi bi-x hoverover click_delete" style="opacity:0" url="{{ url_for("clarama_content.content_render",mode="delete", filename=local_url + folder) }}"></i>-->
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}

                            {% for file in files | sortnicely %}
                                <div class="favorites-div list-group-item list-group-item-action d-flex">
                                    <a href="{{ url_for("clarama_content.content_get", mode='default', filename=local_url + file) }}"
                                       file_div="file_{{ loop.index }}"
                                       listing_file="{{ file }}"
                                       listing_filepath="{{ local_url + file }}"
                                       listing_fullpath="{{ url_for('clarama_content.content_get',mode='default', filename=local_url + file) }}"
                                       listing_icon="{{ get(filetypes, file | fileextension, 'bi-clipboard2-data') }}"
                                       class="container-fluid listing text-black p-0"
                                       style="text-decoration:none"
                                       draggable="true">
                                        <div class="row align-items-center">
                                            <div class="col">
                                                <div class="row row-cols-auto align-items-center flex-nowrap"
                                                     style="width: 100%;">
                                                    <input type="checkbox"
                                                           class="multi-select-checkbox clarama-checkbox form-check-input me-2 d-none"
                                                    />
                                                    <i class="bi {{ get(filetypes, file | fileextension, 'bi-clipboard2-data') }} position-relative col pe-0"
                                                       style="font-size: 1.6rem;">
                                                        <!--<div class="clarama-embedded rounded-pill badge-notification position-absolute translate-middle" style="font-size: 0.6em; left: 80%!important;top: 20%!important;" url="{{ url_for("clarama_web_git.git_versioning",mode='explore',filetype='file',filename=local_url + file) }}">
                                            </div>-->
                                                    </i>
                                                    <div id="file_{{ loop.index }}"
                                                         class="col d-flex align-items-center listing_div"
                                                         style="word-break: break-word;">{{ file | filebasename }}</div>
                                                </div>
                                            </div>
                                            <div class="col col-sm-3 text-end">{{ get(filetype_names, file | fileextension, file | fileextension) }}</div>
                                            <!--<i class="col col-sm-1 bi bi-x hoverover click_delete" style="opacity:0" url="{{ url_for("clarama_content.content_render",mode='delete', filename=local_url + file) }}"></i>-->
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                            <div class="container-fluid">
                                <form class="row">
                                    <fieldset class="upload_dropZone text-center mb-3 p-4"
                                              data-filepath="{{ local_url }}"
                                              data-fullpath="{{ fullpath }}">
                                        <legend class="visually-hidden">Image uploader</legend>
                                        <p class="small my-2">Drag &amp; Drop supported files <i>or</i>
                                            <input id="upload_image_background" data-post-name="image_background"
                                                   data-post-url="{{ url_for("clarama_content.content_get",mode='explore', filename=local_url) }}"
                                                   class="position-absolute invisible"
                                                   type="file"/>
                                            <label for="upload_image_background" type="button"
                                                   class="btn btn-c2 m-1">Choose file(s)</label></p>
                                        <div class="upload_gallery d-flex flex-wrap justify-content-center gap-3 mb-0"></div>
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-7">
                {% if content %}
                    <!--
                        <nav class="card-header navbar navbar-expand-xl navbar-dark bg-dark">
                            <div class="container-fluid">
                                <h1 class="navbar-brand">{{ active_content }}</h1>
                                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#navbarFolder" aria-controls="navbarFolder"
                                        aria-expanded="false"
                                        aria-label="Toggle navigation">
                                    <span class="navbar-toggler-icon"></span>
                                </button>
                            </div>
                        </nav>
                        -->

                    <div class="clarama-embedded" url="/render/embed-plain/{{ content }}"></div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Progress -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">Uploading...</h5>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- dlt confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-c2-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="confirmDeleteBtn" type="button" class="btn btn-danger" onclick="context_delete()">Yes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Move confirmation Modal -->
    <div class="modal fade" id="moveConfirmModal" tabindex="-1" aria-labelledby="moveConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moveConfirmModalLabel">Confirm Move</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="moveConfirmText">
                    Are you sure you want to move the selected item(s)?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-c2-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="confirmMoveBtn" type="button" class="btn btn-danger">Move</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        function favorite_listing() {
            var file_div = $("#context-menu").attr('file_div').split("_");
            var file = $("#context-menu").attr("listing_file");
            var fullpath = $("#context-menu").attr('listing_fullpath');
            var icon = $("#context-menu").attr('listing_icon');

            toggle_favorite(file, fullpath, icon, '{{username}}', file_div[0]);
        }

        function isValidFilename(name) {
            // Trim whitespace for validation but keep original for submission
            if (typeof name !== 'string') {
                flash("Invalid name.", "danger");
                return false;
            }
            const trimmed = name.trim();

            // 1. Required and max length 64
            if (trimmed.length === 0) {
                flash("File or folder name cannot be empty.", "danger");
                return false;
            }
            if (trimmed.length > 64) {
                flash("Name too long (max 64 characters).", "danger");
                return false;
            }

            // 2. Cannot be '.' or '..' (but allow dotfiles like '.env')
            if (trimmed === '.' || trimmed === '..') {
                flash("Name cannot be '.' or '..'.", "danger");
                return false;
            }

            // 3. Disallow '/'
            if (trimmed.includes('/')) {
                flash("Name cannot contain '/'.", "danger");
                return false;
            }

            // 4. Disallow NUL and other ASCII control characters (0x00-0x1F)
            for (let i = 0; i < trimmed.length; i++) {
                const code = trimmed.charCodeAt(i);
                if (code >= 0 && code < 32) {
                    flash("Name cannot contain control characters.", "danger");
                    return false;
                }
            }

            return true;
        }

        function getExistingNames(excludeElement = null) {
            let existingNames = new Set();
            $('.listing_div').each(function () {
                // Skip the element we're currently editing
                if (excludeElement && this === excludeElement) {
                    return; // Continue to next iteration
                }

                const name = $(this).text().trim();
                if (name) existingNames.add(name);
            });
            return existingNames;
        }

        function content_new_explore() {
            var new_content = $("#new_content").val().trim();
            var new_content_type = $("#new_content_type").val();
            const reload = isValidFilename(new_content);

            if (!isValidFilename(new_content)) return;

            const existingNames = getExistingNames();

            if (existingNames.has(new_content)) {
                flash("A file or folder with that name already exists.", "danger");
                console.log('newwww type:', new_content_type);
                return;  // Stop creation
            }

            const file = "/render/new/{{ local_url }}/?new_content=" +
                encodeURIComponent(new_content) +
                "&new_content_type=" +
                encodeURIComponent(new_content_type);

            execute_json_url(file, reload);
        }

        function context_rename() {
            console.log("Renaming " + $("#context-menu").attr("listing_file") + ' in ' + $("#context-menu").attr("file_div"));
            var file_div = $("#context-menu").attr("file_div");
            var parent_link = $('#' + file_div).closest("a");
            $('#' + file_div).attr('contenteditable', true).focus();
            parent_link.click(function (event) {
                event.preventDefault();
            });
            $("#context-menu").removeClass("show").hide();
        }

        function getSelectedFilepaths() {
            // Find all checked checkboxes
            const paths = [];
            $('.multi-select-checkbox:checked').each(function () {
                const filepath = $(this).closest('.favorites-div').find('a').attr('listing_filepath');
                if (filepath) {
                    paths.push(filepath);
                }
            });
            return paths;
        }

        function context_delete() {
            const files = getSelectedFilepaths();
            if (files.length === 0) {                       // no selection
                var file = "/render/delete/" + $("#context-menu").attr("listing_filepath");
                execute_json_url(file, true);
                $("#context-menu").removeClass("show").hide();
            } else {                                        // mulitple files/folders selected
                files.forEach(file => {
                    var url = "/render/delete/" + file;
                    execute_json_url(url, true);
                });
            }
            $("#context-menu").removeClass("show").hide();
            exitSelectMode();
        }

        function context_cut() {
            const files = getSelectedFilepaths();

            if (files.length === 0) {
                var file = $("#context-menu").attr("listing_filepath");
                navigator.clipboard.writeText(encodeURIComponent(file) + "&mode=cut");
            } else {
                const encodedFiles = files.map(f => encodeURIComponent(f)).join(",");
                navigator.clipboard.writeText(encodedFiles + "&mode=cut");
            }

            $("#context-menu").removeClass("show").hide();
            exitSelectMode();
        }

        function context_copy() {
            const files = getSelectedFilepaths();
            let dataToCopy;

            if (files.length === 0) { // no selection
                const file = $("#context-menu").attr("listing_filepath");
                dataToCopy = encodeURIComponent(file) + "&mode=copy";
            } else {
                dataToCopy = encodeURIComponent(files.join(",")) + "&mode=copy";
            }

            navigator.clipboard.writeText(dataToCopy)
                .then(() => {
                    console.log("Copied:", dataToCopy);
                })
                .catch(err => {
                    console.error('Failed to write to clipboard: ', err);
                });

            $("#context-menu").removeClass("show").hide();
            exitSelectMode();
        }

        // Things to watch out for:
        // Pasting a folder inside it's own child
        // Can't paste to an empty folder
        // File pasting into current folder should create a duplicate

        function context_paste() {
            navigator.clipboard.readText()
                .then(source => {
                    // Split on '&mode=' to get path(s) and mode
                    const [encodedPaths, mode] = source.split("&mode=");
                    const paths = decodeURIComponent(encodedPaths).split(",");

                    const targetPath = $("#context-menu").attr("listing_filepath");

                    paths.forEach(path => {
                        const file = `/render/paste/${targetPath}?source=${encodeURIComponent(path)}&mode=${mode}`;
                        execute_json_url(file, true);
                    });
                })
                .catch(err => {
                    console.error('Failed to read clipboard contents: ', err);
                });

            $("#context-menu").removeClass("show").hide();
        }

        function rename_finished(object) {
            var newName = $(object).text().trim();
            $(object).attr('contenteditable', false);

            var existingNames = getExistingNames(object);

            if (!isValidFilename(newName)) {
                flash("Invalid file or folder name.", "danger");
                return;
            }

            var currentName = $("#context-menu").attr("listing_file");
            existingNames.delete(currentName);

            if (existingNames.has(newName)) {
                flash("A file or folder with that name already exists.", "danger");
                $(object).text(currentName);
                return;
            }

            var file = "/render/rename/" + $("#context-menu").attr("listing_filepath") + '?new_name=' + encodeURIComponent(newName);

            execute_json_url(file, true);
            console.log("renaming");
        }

        function enterSelectMode() {
            selecting = true;
            $('.multi-select-checkbox').removeClass('d-none');
            $('#toggle_select_mode')
                .removeClass('text-secondary')
                .addClass('text-white')
                .html('<i class="bi bi-x-square"></i> Cancel');
        }

        function exitSelectMode() {
            selecting = false;
            anchorIndex = null;
            checkboxes.addClass('d-none').prop('checked', false);
            $('#toggle_select_mode')
                .removeClass('text-white')
                .addClass('text-secondary')
                .html('<i class="bi bi-check-square"></i> Select');
        }

        $(document).ready(function () {
            console.log('Ready!');

            // Form submission (scoped to folder page only)
            $('#explore-card')
                .off('submit.exploreNew', '#new_content_form')
                .on('submit.exploreNew', '#new_content_form', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    content_new_explore();
                });

            // Click outside any listing to hide the context menu
            $(document).on("click contextmenu", function (e) {
                if (!$(e.target).closest("#dropzone-context-menu, .upload_dropZone").length) {
                    $("#dropzone-context-menu").removeClass("show").hide();
                }
                if (!$(e.target).closest('.listing').length) {
                    $('#context-menu').removeClass("show").hide();
                }
            });

            $('.listing_div').on('focusout', function () {
                rename_finished(this);
            });

            $('.listing_div').keypress(function (ev) {
                if ((ev.keyCode ? ev.keyCode : ev.which) === 13) {
                    $(this).attr('contenteditable', false);
                }
            });

            // Context menu for file/folder listings
            $('.listing').on('contextmenu', function (e) {
                e.preventDefault();
                e.stopPropagation();

                // Hide dropzone menu if it's open
                $("#dropzone-context-menu").removeClass("show").hide();

                var top = e.pageY - 10;
                var left = e.pageX - 10;

                var item = $(this);
                var file_div = item.attr('file_div');
                var file = item.attr('listing_file');
                var filepath = item.attr('listing_filepath');
                var fullpath = item.attr('listing_fullpath');
                var icon = item.attr('listing_icon');
                var url = item.attr('href');

                $("#context-menu").attr({
                    "file_div": file_div,
                    "listing_file": file,
                    "listing_filepath": filepath,
                    "listing_path": "{{ local_url }}",
                    "listing_fullpath": fullpath,
                    "listing_icon": icon
                });

                var starIcon = document.getElementById("menu_favorites");
                if (favoriteFiles.some(row => row[1] === fullpath)) {
                    starIcon.classList.remove('bi-star');
                    starIcon.classList.add('bi-star-fill');
                    starIcon.textContent = " Favorited";
                } else {
                    starIcon.classList.remove('bi-star-fill');
                    starIcon.classList.add('bi-star');
                    starIcon.textContent = " Favorite";
                }

                $('#menu_open').attr("href", url);
                $('#menu_download').attr("href", "/content/download/" + filepath);
                $('#menu_delete').attr("href", "/content/delete/" + filepath);

                $("#context-menu").css({
                    display: "block",
                    top: top,
                    left: left
                }).addClass("show");

                return false;
            });

            // Context menu item click
            $("#context-menu a").on("click", function () {
                $(this).parent().removeClass("show").hide();
            });

            // Toggle “New …” UI (scoped, namespaced)
            $('#explore-card')
                .off('click.exploreNew', '.toggle_show')
                .on('click.exploreNew', '.toggle_show', function (e) {
                    e.stopPropagation();             // don’t bubble into modal listeners
                    e.stopImmediatePropagation();    // don’t trigger other global handlers
                    const new_class = this.getAttribute("new_file_class");
                    const new_type = this.getAttribute("new_file_type");
                    const $scope = $('#explore-card');
                    $scope.find(".new_content_type").val(new_type);
                    $scope.find(".new_item")
                        .removeClass("bi-folder bi-journal-arrow-down bi-file-earmark-spreadsheet bi-blockquote-left bi-table bi-database bi-menu-app bi-eye bi-sliders")
                        .addClass(new_class);
                    $scope.find(".toggle_target").show('fast');
                });

            $('#explore-card')
                .off('click.exploreNew', '.toggle_hide')
                .on('click.exploreNew', '.toggle_hide', function () {
                    $('#explore-card .toggle_target').hide('fast');
                });

            $(".click_delete").click(function (e) {
                e.preventDefault();
                var url = $(this).attr("url");

                console.log("Deleting " + url);
                fetch($CLARAMA_ROOT + url)
                    .then(response => {
                        console.log(response);
                        history.go(0);
                    });
            });

            // Dropzone (folder) context menu
            $(".upload_dropZone").on("contextmenu", function (e) {
                e.preventDefault();
                e.stopPropagation();

                // Hide listing context menu if visible
                $("#context-menu").removeClass("show").hide();

                var top = e.pageY - 10;
                var left = e.pageX - 10;

                var folderPath = $(this).attr("data-filepath");
                var fullpath = $(this).attr("data-fullpath");

                $("#context-menu").attr({
                    "file_div": null,
                    "listing_file": null,
                    "listing_filepath": folderPath,
                    "listing_path": folderPath,
                    "listing_fullpath": fullpath,
                    "listing_icon": "folder"
                });

                $("#dropzone-context-menu").css({
                    display: "block",
                    top: top,
                    left: left
                }).addClass("show");

                return false;
            });
        });

        // Drag and drop - single or multiple image files
        // https://www.smashingmagazine.com/2018/01/drag-drop-file-uploader-vanilla-js/
        // https://codepen.io/joezimjs/pen/yPWQbd?editors=1000
        (function () {

            // Four objects of interest: drop zones, input elements, gallery elements, and the files.
            // dataRefs = {files: [image files], input: element ref, gallery: element ref}

            const preventDefaults = event => {
                event.preventDefault();
                event.stopPropagation();
            };

            const highlight = event =>
                event.target.classList.add('highlight');

            const unhighlight = event =>
                event.target.classList.remove('highlight');

            const getInputAndGalleryRefs = element => {
                const zone = element.closest('.upload_dropZone') || false;
                const gallery = zone.querySelector('.upload_gallery') || false;
                const input = zone.querySelector('input[type="file"]') || false;
                return {input: input, gallery: gallery};
            }

            const handleDrop = event => {
                const dataRefs = getInputAndGalleryRefs(event.target);
                dataRefs.files = event.dataTransfer.files;
                handleFiles(dataRefs);
            }


            const eventHandlers = zone => {

                const dataRefs = getInputAndGalleryRefs(zone);
                if (!dataRefs.input) return;

                // Prevent default drag behaviors
                ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                    zone.addEventListener(event, preventDefaults, false);
                    document.body.addEventListener(event, preventDefaults, false);
                });

                // Highlighting drop area when item is dragged over it
                ;['dragenter', 'dragover'].forEach(event => {
                    zone.addEventListener(event, highlight, false);
                });
                ;['dragleave', 'drop'].forEach(event => {
                    zone.addEventListener(event, unhighlight, false);
                });

                // Handle dropped files
                zone.addEventListener('drop', handleDrop, false);

                // Handle browse selected files
                dataRefs.input.addEventListener('change', event => {
                    dataRefs.files = event.target.files;
                    handleFiles(dataRefs);
                }, false);

            }


            // Initialise ALL dropzones
            const dropZones = document.querySelectorAll('.upload_dropZone');
            for (const zone of dropZones) {
                eventHandlers(zone);
            }


            // No 'image/gif' or PDF or webp allowed here, but it's up to your use case.
            // Double checks the input "accept" attribute
            const isImageFile = file =>
                ['text/plain', 'text/html', 'image/jpeg', 'image/png', 'image/svg+xml', 'text/csv', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/pdf', 'application/x-zip'].includes(file.type);

            
            // Based on: https://flaviocopes.com/how-to-upload-files-fetch/
            const imageUpload = dataRefs => {

                const modal = new bootstrap.Modal(document.getElementById('progressModal'));
                modal.show(); // Show the popup

                function startProgress() {
                    let progress = 0;
                    const progressBar = document.getElementById('progress-bar');
                    const interval = setInterval(() => {
                        if (progress < 90) { // Simulate progress up to 90%
                            progress += 10;
                            progressBar.style.width = progress + "%";
                            progressBar.setAttribute('aria-valuenow', progress);
                        } else {
                            clearInterval(interval);
                        }
                    }, 200);
                    return interval;
                }

                const progressInterval = startProgress();

                // Multiple source routes, so double check validity
                if (!dataRefs.files || !dataRefs.input) return;

                const url = dataRefs.input.getAttribute('data-post-url');

                console.log(url);
                if (!url) return;

                const formData = new FormData();

                for (const file of dataRefs.files) {
                    formData.append("file", file, file.name);
                    console.log(file.name);
                }

                //const formData = new FormData();
                //formData.append("file", dataRefs.files[0]);

                fetch(url, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        clearInterval(progressInterval);
                        document.getElementById('progress-bar').style.width = "100%";
                        document.getElementById('progress-bar').setAttribute('aria-valuenow', 100);
                        setTimeout(() => {
                            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                            modalInstance.hide(); // Hide the popup after upload
                        }, 500);

                        console.log('posted: ', data);
                        if (data.retrieval === true) {
                            // previewFiles(dataRefs);
                            window.location.reload();
                        } else {
                            console.log('URL: ', url, '  name: ', name)
                        }
                    })
                    .catch(error => {
                        console.error('errored: ', error);
                        document.getElementById('progressModalLabel').textContent = "Error!";
                        document.getElementById('progress-bar').classList.add('bg-danger');
                    });
            }


            // Handle both selected and dropped files
            const handleFiles = dataRefs => {

                let files = [...dataRefs.files];

                // Remove unaccepted file types
                /*files = files.filter(item => {
                    if (!isImageFile(item)) {
                        console.log('Not an image, ', item.type);
                        alert(item.type + ' not a valid file for upload');
                    }
                    return isImageFile(item) ? item : null;
                });*/

                if (!files.length) return;
                dataRefs.files = files;

                imageUpload(dataRefs);
            }

        })();

        // multiple selection mode
        let selecting = false;
        let anchorIndex = null;

        const checkboxes = $('.multi-select-checkbox');
        const listings = $('.listing');

        // Toggle select mode button
        $('#toggle_select_mode').on('click', function () {
            selecting = !selecting;
            $('.multi-select-checkbox').toggleClass('d-none', !selecting);

            if (selecting) {
                $(this)
                    .removeClass('text-secondary')
                    .addClass('text-white')
                    .html('<i class="bi bi-x-square"></i> Cancel');
            } else {
                exitSelectMode();
            }
        });

        // Prevent opening files/folders when in select mode
        $('.listing').on('click', function (e) {
            if ($(e.target).hasClass('multi-select-checkbox')) return;

            // Hide any open context menu
            $("#context-menu").removeClass("show").hide();
            $("#dropzone-context-menu").removeClass("show").hide();

            const index = listings.index(this);
            const checkbox = $(this).closest('.favorites-div').find('.multi-select-checkbox');

            if (e.ctrlKey && !selecting) enterSelectMode()      // actvate select mode with ctrl key

            if (e.shiftKey) {
                if (!selecting) enterSelectMode()               // activate select mode with shift key

                if (anchorIndex === null) {
                    anchorIndex = index;
                    checkbox.prop('checked', true);
                } else {
                    const start = Math.min(anchorIndex, index);
                    const end = Math.max(anchorIndex, index);

                    // Uncheck all first
                    checkboxes.prop('checked', false);

                    for (let i = start; i <= end; i++) {
                        checkboxes.eq(i).prop('checked', true);
                    }
                }

                e.preventDefault();
                e.stopPropagation();

            } else if (selecting) {
                const isChecked = checkbox.prop('checked');
                checkbox.prop('checked', !isChecked);

                if (!isChecked && anchorIndex === null) anchorIndex = index;

                // If all checkboxes are now unchecked, reset anchorIndex
                if (checkboxes.filter(':checked').length === 0) anchorIndex = null;

                e.preventDefault();
                e.stopPropagation();
            }

            $(document).on('keydown', function (e) {

                if (e.key === "Escape" && selecting) {          // Exit select mode on Escape ke
                    exitSelectMode();
                }

                if (e.key === "Delete" && selecting) {          // Delete selected listings on Delete key
                    e.preventDefault();
                    $('#deleteConfirmModal').modal('show');
                }

                if (e.ctrlKey && (e.key === "c" || e.key === "C")) {    // Ctrl + c (copy)
                    e.preventDefault();
                    context_copy();
                }

                if (e.ctrlKey && (e.key === "x" || e.key === "X")) {    // Ctrl + x (cut)
                    e.preventDefault();
                    context_cut();
                }

                // if (e.ctrlKey && (e.key === "v" || e.key === "V")) {  // Ctrl + v (paste)
                //     e.preventDefault();
                //     context_paste();
                // }

            });
        });
        // Drag-to move/copy between folders (Ctrl = copy, default = move)
        (function(){
            const getSelectedFilepaths = window.getSelectedFilepaths || function(){
                const paths=[]; $('.multi-select-checkbox:checked').each(function(){
                    const p=$(this).closest('.favorites-div').find('a').attr('listing_filepath');
                    if(p) paths.push(p);
                });
                return paths;
            };

            function getDragPathsFromAnchor(anchor){
                const selected = getSelectedFilepaths();
                if (selected && selected.length>0) return selected;
                const fp = anchor.getAttribute('listing_filepath');
                return fp ? [fp] : [];
            }

            function setDropEffect(e){
                try { e.dataTransfer.dropEffect = e.ctrlKey ? 'copy' : 'move'; } catch(_){}
            }

            function isInvalidMove(paths, target){
                // Disallow moving into itself or its descendant
                for (const p of paths){
                    if (p === target) return `Cannot move '${p}' into itself.`;
                    if (target.startsWith(p + '/')) return `Cannot move '${p}' into its own subfolder.`;
                }
                return null;
            }

            function pasteMany(paths, targetPath, mode){
                paths.forEach(path=>{
                    const url = `/render/paste/${targetPath}?source=${encodeURIComponent(path)}&mode=${mode}`;
                    execute_json_url(url, true);
                });
            }

            // State for pending move confirmation
            let pendingDrop = null;
            const moveModalEl = document.getElementById('moveConfirmModal');
            const moveTextEl = document.getElementById('moveConfirmText');
            const confirmBtn = document.getElementById('confirmMoveBtn');
            if (confirmBtn){
                confirmBtn.addEventListener('click', function(){
                    if (!pendingDrop) return;
                    const {paths, targetPath} = pendingDrop;
                    pasteMany(paths, targetPath, 'cut');
                    pendingDrop = null;
                    // hide modal
                    const modal = bootstrap.Modal.getInstance(moveModalEl) || new bootstrap.Modal(moveModalEl);
                    modal.hide();
                });
            }

            // Drag start from any listing (file or folder)
            document.addEventListener('dragstart', function(e){
                const a = e.target && e.target.closest && e.target.closest('a.listing');
                if (!a) return;
                const paths = getDragPathsFromAnchor(a);
                if (!paths.length) return;
                try {
                    e.dataTransfer.setData('application/json', JSON.stringify({paths}));
                    e.dataTransfer.effectAllowed = 'copyMove';
                } catch(_){}
            });

            function handleDragOver(e){
                const a = e.currentTarget;
                e.preventDefault();
                setDropEffect(e);
                a.classList.add('drop-target');
            }
            function clearDragOver(e){
                const a = e.currentTarget;
                a.classList.remove('drop-target');
            }

            function onDropToTarget(e, targetPath){
                e.preventDefault();
                let payload = null;
                try { payload = JSON.parse(e.dataTransfer.getData('application/json')||'{}'); } catch(_){}
                const paths = (payload && payload.paths) || [];
                if (!paths.length) return;

                const invalid = isInvalidMove(paths, targetPath);
                if (invalid){ flash(invalid, 'warning'); return; }

                const isCopy = !!e.ctrlKey;
                if (isCopy){
                    pasteMany(paths, targetPath, 'copy');
                } else {
                    // Determine if any dragged item is a folder (present in DOM with folder icon)
                    let movingFolder = false;
                    document.querySelectorAll('a.listing[listing_icon="bi-folder-fill"]').forEach(a => {
                        const fp = a.getAttribute('listing_filepath');
                        if (paths.includes(fp)) movingFolder = true;
                    });

                    if (movingFolder){
                        // Ask confirmation only when moving folders
                        if (moveTextEl){
                            const name = targetPath.split('/').filter(Boolean).slice(-1)[0] || targetPath;
                            moveTextEl.textContent = `Move ${paths.length} item(s) to '${name}'?`;
                        }
                        pendingDrop = {paths, targetPath};
                        const modal = new bootstrap.Modal(moveModalEl);
                        modal.show();
                    } else {
                        // Move files immediately without confirmation
                        pasteMany(paths, targetPath, 'cut');
                    }
                }
            }

            // Make folder rows act as drop targets
            document.querySelectorAll('a.listing[listing_icon="bi-folder-fill"]').forEach(a=>{
                a.addEventListener('dragover', handleDragOver);
                a.addEventListener('dragenter', handleDragOver);
                a.addEventListener('dragleave', clearDragOver);
                a.addEventListener('drop', function(e){
                    clearDragOver(e);
                    const targetPath = a.getAttribute('listing_filepath');
                    onDropToTarget(e, targetPath);
                });
            });

            // Allow dropping to the folder dropzone (current folder)
            document.querySelectorAll('.upload_dropZone').forEach(zone=>{
                zone.addEventListener('dragover', function(e){ e.preventDefault(); setDropEffect(e); zone.classList.add('highlight'); });
                zone.addEventListener('dragleave', function(){ zone.classList.remove('highlight'); });
                zone.addEventListener('drop', function(e){ zone.classList.remove('highlight'); onDropToTarget(e, zone.getAttribute('data-filepath')); });
            });
        })();
    </script>

    <style>
        /* Ensure navbar dropdown is above the list items in Folders Explore */
        #explore-card .navbar,
        #explore-card .card-header {
            position: relative;
            z-index: 2; /* must be above any list item stacking */
        }

        #explore-card .navbar .collapse,
        #explore-card .navbar .dropdown,
        #explore-card .navbar .dropdown-menu {
            overflow: visible;
        }

        #nav-menu .navbar,
        #nav_menu .card-header {
            position: relative;
            z-index: 30000; /* must be above any list item stacking */
        }

        /* Force the dropdown menu to sit above everything else within the card */
        #nav-menu .dropdown-menu,
        #nav-menu .dropdown-menu.show {
            position: absolute; /* ensure positioned for z-index to apply */
            z-index: 30001 !important; /* above navbar and list */
        }

        /* Force the dropdown menu to sit above everything else within the card */
        #explore-card .dropdown-menu,
        #explore-card .dropdown-menu.show {
            position: absolute; /* ensure positioned for z-index to apply */
            z-index: 20001 !important; /* above navbar and list */
        }

        #explore-card .card-body,
        #explore-card .list-group {
            overflow: visible; /* avoid clipping dropdown */
        }

        /* Keep list items below the dropdown by removing any elevated stacking */
        #explore-card .list-group-item {
            position: relative;
            z-index: auto;
        }
        .drop-target { outline: 2px dashed #0d6efd; }
    </style>

{% endblock %}

