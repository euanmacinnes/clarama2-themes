{% set internal_topic = url_for(request.endpoint, **request.view_args) | topic %}

<form>
    <div class="container-fluid bg-light">
        <div class="row" style="padding: 0">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <button type="button" class="btn btn-secondary">Playwright Test</button>
            </div>
            <div class="col">
                <div class="row">
                </div>
            </div>
            <div class="col-auto">
                <ul class="btn-group clarama-test" role="group" aria-label="test_functions">
                    <button id="save" type="button" class="btn btn-secondary clarama-test clarama-test-save"
                            url="{{ file_url }}" title="save"><i
                            class="bi bi-floppy"></i></button>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <hr/>
                <button type="button" class="btn btn-secondary">Configuration</button>
            </div>
            <div class="col mb-3" style="padding: 0">
                <hr/>
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="browser">Browser</label>
                                <select class="form-control" id="browser" name="browser">
                                    <option value="chromium" {% if test.browser == 'chromium' %}selected{% endif %}>Chromium</option>
                                    <option value="firefox" {% if test.browser == 'firefox' %}selected{% endif %}>Firefox</option>
                                    <option value="webkit" {% if test.browser == 'webkit' %}selected{% endif %}>WebKit</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="headless">Headless Mode</label>
                                <select class="form-control" id="headless" name="headless">
                                    <option value="true" {% if test.headless %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if not test.headless %}selected{% endif %}>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="viewport_width">Viewport Width</label>
                                <input type="number" class="form-control" id="viewport_width" name="viewport_width" 
                                       value="{{ test.viewport.width }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="viewport_height">Viewport Height</label>
                                <input type="number" class="form-control" id="viewport_height" name="viewport_height" 
                                       value="{{ test.viewport.height }}">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="timeout">Timeout (ms)</label>
                                <input type="number" class="form-control" id="timeout" name="timeout" 
                                       value="{{ test.timeout }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="screenshot">Screenshot Mode</label>
                                <select class="form-control" id="screenshot" name="screenshot">
                                    <option value="on" {% if test.screenshot == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.screenshot == 'off' %}selected{% endif %}>Never</option>
                                    <option value="only-on-failure" {% if test.screenshot == 'only-on-failure' %}selected{% endif %}>Only on Failure</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="video">Video Recording</label>
                                <select class="form-control" id="video" name="video">
                                    <option value="on" {% if test.video == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.video == 'off' %}selected{% endif %}>Never</option>
                                    <option value="retain-on-failure" {% if test.video == 'retain-on-failure' %}selected{% endif %}>Retain on Failure</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="trace">Trace Recording</label>
                                <select class="form-control" id="trace" name="trace">
                                    <option value="on" {% if test.trace == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.trace == 'off' %}selected{% endif %}>Never</option>
                                    <option value="retain-on-failure" {% if test.trace == 'retain-on-failure' %}selected{% endif %}>Retain on Failure</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Python Code Section -->
        <div class="row">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <hr/>
                <button type="button" class="btn btn-secondary">Python Code</button>
            </div>
            <div class="col mb-3" style="padding: 0">
                <hr/>
                <div class="container-fluid">
                    <div class="form-group">
                        <label for="python_code">Test Code</label>
                        <textarea class="form-control" id="python_code" name="python_code" rows="15" style="font-family: monospace;">{{ test.code|default('# Python code for the test
def test_example(page):
    # Navigate to the page
    page.goto("http://127.0.0.1:5000/")
    
    # Perform actions
    page.get_by_role("textbox", name="username").fill("testuser")
    page.get_by_role("button", name="Sign In").click()
    
    # Assertions for successful rendering
    expect(page.get_by_label("Clarama Header")).to_be_visible()') }}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Success Criteria Section -->
        <div class="row">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <hr/>
                <button type="button" class="btn btn-secondary">Success Criteria</button>
            </div>
            <div class="col mb-3" style="padding: 0">
                <hr/>
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-12">
                            <p class="text-muted">Define criteria to determine if the test has successfully rendered the page.</p>
                        </div>
                    </div>
                    
                    <div id="success-criteria-container">
                        {% if test.success_criteria %}
                            {% for criterion in test.success_criteria %}
                                <div class="row mb-3 success-criterion">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Element Selector</label>
                                            <input type="text" class="form-control criterion-element" value="{{ criterion.element }}">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Condition</label>
                                            <select class="form-control criterion-condition">
                                                <option value="visible" {% if criterion.condition == 'visible' %}selected{% endif %}>Is Visible</option>
                                                <option value="contains" {% if criterion.condition == 'contains' %}selected{% endif %}>Contains Text</option>
                                                <option value="has_value" {% if criterion.condition == 'has_value' %}selected{% endif %}>Has Value</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label>Value</label>
                                            <input type="text" class="form-control criterion-value" value="{{ criterion.value|default('') }}" {% if criterion.condition == 'visible' %}disabled{% endif %}>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label>Timeout (ms)</label>
                                            <input type="number" class="form-control criterion-timeout" value="{{ criterion.timeout|default(5000) }}">
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex align-items-end">
                                        <button type="button" class="btn btn-danger remove-criterion mb-2"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="row mb-3 success-criterion">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Element Selector</label>
                                        <input type="text" class="form-control criterion-element" value="#header">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Condition</label>
                                        <select class="form-control criterion-condition">
                                            <option value="visible" selected>Is Visible</option>
                                            <option value="contains">Contains Text</option>
                                            <option value="has_value">Has Value</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Value</label>
                                        <input type="text" class="form-control criterion-value" disabled>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Timeout (ms)</label>
                                        <input type="number" class="form-control criterion-timeout" value="5000">
                                    </div>
                                </div>
                                <div class="col-auto d-flex align-items-end">
                                    <button type="button" class="btn btn-danger remove-criterion mb-2"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" id="add-criterion">
                                <i class="bi bi-plus-circle"></i> Add Criterion
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    $(document).ready(function() {
        // Handle condition change to enable/disable value field
        $(document).on('change', '.criterion-condition', function() {
            var valueField = $(this).closest('.success-criterion').find('.criterion-value');
            if ($(this).val() === 'visible') {
                valueField.prop('disabled', true);
            } else {
                valueField.prop('disabled', false);
            }
        });
        
        // Add new criterion
        $('#add-criterion').click(function() {
            var newCriterion = `
                <div class="row mb-3 success-criterion">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Element Selector</label>
                            <input type="text" class="form-control criterion-element" value="">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Condition</label>
                            <select class="form-control criterion-condition">
                                <option value="visible" selected>Is Visible</option>
                                <option value="contains">Contains Text</option>
                                <option value="has_value">Has Value</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Value</label>
                            <input type="text" class="form-control criterion-value" disabled>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Timeout (ms)</label>
                            <input type="number" class="form-control criterion-timeout" value="5000">
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-criterion mb-2"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
            $('#success-criteria-container').append(newCriterion);
        });
        
        // Remove criterion
        $(document).on('click', '.remove-criterion', function() {
            $(this).closest('.success-criterion').remove();
        });
        
        $('.clarama-test-save').click(function() {
            // Collect success criteria
            var successCriteria = [];
            $('.success-criterion').each(function() {
                var element = $(this).find('.criterion-element').val();
                var condition = $(this).find('.criterion-condition').val();
                var value = $(this).find('.criterion-value').val();
                var timeout = parseInt($(this).find('.criterion-timeout').val());
                
                if (element) {
                    var criterion = {
                        element: element,
                        condition: condition,
                        timeout: timeout
                    };
                    
                    if (condition !== 'visible') {
                        criterion.value = value;
                    }
                    
                    successCriteria.push(criterion);
                }
            });
            
            var testConfig = {
                browser: $('#browser').val(),
                headless: $('#headless').val() === 'true',
                viewport: {
                    width: parseInt($('#viewport_width').val()),
                    height: parseInt($('#viewport_height').val())
                },
                timeout: parseInt($('#timeout').val()),
                screenshot: $('#screenshot').val(),
                video: $('#video').val(),
                trace: $('#trace').val(),
                code: $('#python_code').val(),
                success_criteria: successCriteria
            };
            
            $.ajax({
                url: '/explorer/save/' + $(this).attr('url'),
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(testConfig),
                success: function(response) {
                    console.log('Test configuration saved successfully');
                    // Show success message
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      'Test configuration saved successfully!' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>').prependTo('.container-fluid').delay(3000).fadeOut();
                },
                error: function(error) {
                    console.error('Error saving test configuration:', error);
                    // Show error message
                    $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                      'Error saving test configuration!' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>').prependTo('.container-fluid');
                }
            });
        });
    });
</script>

{% include theme("web/file_footer.html") %}