{% set internal_topic = url_for(request.endpoint, **request.view_args) | topic %}

<form>
    <div class="container-fluid bg-light">
        <div class="row" style="padding: 0">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <button type="button" class="btn btn-secondary">Playwright Test</button>
            </div>
            <div class="col">
                <div class="row">
                </div>
            </div>
            <div class="col-auto">
                <ul class="btn-group clarama-test" role="group" aria-label="test_functions">
                    <button id="save" type="button" class="btn btn-secondary clarama-test clarama-test-save"
                            url="{{ file_url }}" title="save"><i
                            class="bi bi-floppy"></i></button>
                    <button id="execute" type="button" class="btn btn-secondary clarama-test clarama-test-execute"
                            url="{{ file_url }}" title="Execute Test"><i
                            class="bi bi-play"></i></button>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <hr/>
                <button type="button" class="btn btn-secondary">Configuration</button>
            </div>
            <div class="col mb-3" style="padding: 0">
                <hr/>
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="browser">Browser</label>
                                <select class="form-control" id="browser" name="browser">
                                    <option value="chromium" {% if test.browser == 'chromium' %}selected{% endif %}>Chromium</option>
                                    <option value="firefox" {% if test.browser == 'firefox' %}selected{% endif %}>Firefox</option>
                                    <option value="webkit" {% if test.browser == 'webkit' %}selected{% endif %}>WebKit</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="headless">Headless Mode</label>
                                <select class="form-control" id="headless" name="headless">
                                    <option value="true" {% if test.headless %}selected{% endif %}>Yes</option>
                                    <option value="false" {% if not test.headless %}selected{% endif %}>No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="viewport_width">Viewport Width</label>
                                <input type="number" class="form-control" id="viewport_width" name="viewport_width" 
                                       value="{{ test.viewport.width }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="viewport_height">Viewport Height</label>
                                <input type="number" class="form-control" id="viewport_height" name="viewport_height" 
                                       value="{{ test.viewport.height }}">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="timeout">Timeout (ms)</label>
                                <input type="number" class="form-control" id="timeout" name="timeout" 
                                       value="{{ test.timeout }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="screenshot">Screenshot Mode</label>
                                <select class="form-control" id="screenshot" name="screenshot">
                                    <option value="on" {% if test.screenshot == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.screenshot == 'off' %}selected{% endif %}>Never</option>
                                    <option value="only-on-failure" {% if test.screenshot == 'only-on-failure' %}selected{% endif %}>Only on Failure</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="video">Video Recording</label>
                                <select class="form-control" id="video" name="video">
                                    <option value="on" {% if test.video == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.video == 'off' %}selected{% endif %}>Never</option>
                                    <option value="retain-on-failure" {% if test.video == 'retain-on-failure' %}selected{% endif %}>Retain on Failure</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="trace">Trace Recording</label>
                                <select class="form-control" id="trace" name="trace">
                                    <option value="on" {% if test.trace == 'on' %}selected{% endif %}>Always</option>
                                    <option value="off" {% if test.trace == 'off' %}selected{% endif %}>Never</option>
                                    <option value="retain-on-failure" {% if test.trace == 'retain-on-failure' %}selected{% endif %}>Retain on Failure</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Blocks Section -->
        <div class="row">
            <div class="col-1 bg-secondary text-light" style="padding: 0">
                <hr/>
                <button type="button" class="btn btn-secondary">Test Blocks</button>
            </div>
            <div class="col mb-3" style="padding: 0">
                <hr/>
                <div class="container-fluid">
                    <div class="row mb-3">
                        <div class="col-12">
                            <p class="text-muted">Define blocks of Playwright actions to execute in sequence.</p>
                        </div>
                    </div>
                    
                    <div id="test-blocks-container">
                        {% if test.blocks %}
                            {% for block in test.blocks %}
                                <div class="card mb-4 test-block">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="input-group">
                                            <span class="input-group-text">Block Name</span>
                                            <input type="text" class="form-control block-name" value="{{ block.name }}">
                                        </div>
                                        <button type="button" class="btn btn-danger remove-block"><i class="bi bi-trash"></i></button>
                                    </div>
                                    <div class="card-body">
                                        <h5>Actions</h5>
                                        <div class="actions-container">
                                            {% for action in block.actions %}
                                                <div class="card mb-3 action-item">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <select class="form-control action-type">
                                                            <option value="goto" {% if action.type == 'goto' %}selected{% endif %}>goto</option>
                                                            <option value="get_by_role" {% if action.type == 'get_by_role' %}selected{% endif %}>get_by_role</option>
                                                            <option value="page_locator" {% if action.type == 'page_locator' %}selected{% endif %}>page_locator</option>
                                                        </select>
                                                        <button type="button" class="btn btn-danger remove-action"><i class="bi bi-trash"></i></button>
                                                    </div>
                                                    <div class="card-body">
                                                        <!-- Dynamic fields based on action type -->
                                                        <div class="goto-fields" {% if action.type != 'goto' %}style="display: none;"{% endif %}>
                                                            <div class="form-group">
                                                                <label>URL</label>
                                                                <input type="text" class="form-control goto-url" value="{{ action.url|default('') }}">
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="get_by_role-fields" {% if action.type != 'get_by_role' %}style="display: none;"{% endif %}>
                                                            <div class="form-group mb-3">
                                                                <label>Role</label>
                                                                <input type="text" class="form-control get_by_role-role" value="{{ action.role|default('') }}">
                                                            </div>
                                                            <div class="form-group mb-3">
                                                                <label>Name</label>
                                                                <input type="text" class="form-control get_by_role-name" value="{{ action.name|default('') }}">
                                                            </div>
                                                            
                                                            <h6>Role Actions</h6>
                                                            <div class="role-actions-container">
                                                                {% if action.actions %}
                                                                    {% for role_action in action.actions %}
                                                                        <div class="card mb-2 role-action-item">
                                                                            <div class="card-body">
                                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                                    <select class="form-control role-action-type">
                                                                                        <option value="click" {% if role_action.type == 'click' %}selected{% endif %}>click</option>
                                                                                        <option value="fill" {% if role_action.type == 'fill' %}selected{% endif %}>fill</option>
                                                                                        <option value="press" {% if role_action.type == 'press' %}selected{% endif %}>press</option>
                                                                                    </select>
                                                                                    <button type="button" class="btn btn-danger remove-role-action"><i class="bi bi-trash"></i></button>
                                                                                </div>
                                                                                
                                                                                <div class="fill-fields" {% if role_action.type != 'fill' %}style="display: none;"{% endif %}>
                                                                                    <div class="form-group">
                                                                                        <label>Value</label>
                                                                                        <input type="text" class="form-control fill-value" value="{{ role_action.value|default('') }}">
                                                                                    </div>
                                                                                </div>
                                                                                
                                                                                <div class="press-fields" {% if role_action.type != 'press' %}style="display: none;"{% endif %}>
                                                                                    <div class="form-group">
                                                                                        <label>Key</label>
                                                                                        <input type="text" class="form-control press-key" value="{{ role_action.key|default('') }}">
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                {% endif %}
                                                            </div>
                                                            <button type="button" class="btn btn-sm btn-primary add-role-action">
                                                                <i class="bi bi-plus-circle"></i> Add Role Action
                                                            </button>
                                                        </div>
                                                        
                                                        <div class="page_locator-fields" {% if action.type != 'page_locator' %}style="display: none;"{% endif %}>
                                                            <div class="form-group">
                                                                <label>Selector</label>
                                                                <input type="text" class="form-control page_locator-selector" value="{{ action.selector|default('') }}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-primary add-action">
                                            <i class="bi bi-plus-circle"></i> Add Action
                                        </button>
                                        
                                        <h5 class="mt-4">Expectations</h5>
                                        <div class="expects-container">
                                            {% if block.expects %}
                                                {% for expect in block.expects %}
                                                    <div class="row mb-3 expect-item">
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label>Element Selector</label>
                                                                <input type="text" class="form-control expect-element" value="{{ expect.element }}">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-group">
                                                                <label>Condition</label>
                                                                <select class="form-control expect-condition">
                                                                    <option value="visible" {% if expect.condition == 'visible' %}selected{% endif %}>Is Visible</option>
                                                                    <option value="contains" {% if expect.condition == 'contains' %}selected{% endif %}>Contains Text</option>
                                                                    <option value="has_value" {% if expect.condition == 'has_value' %}selected{% endif %}>Has Value</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-group">
                                                                <label>Value</label>
                                                                <input type="text" class="form-control expect-value" value="{{ expect.value|default('') }}" {% if expect.condition == 'visible' %}disabled{% endif %}>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <div class="form-group">
                                                                <label>Timeout (ms)</label>
                                                                <input type="number" class="form-control expect-timeout" value="{{ expect.timeout|default(5000) }}">
                                                            </div>
                                                        </div>
                                                        <div class="col-auto d-flex align-items-end">
                                                            <button type="button" class="btn btn-danger remove-expect mb-2"><i class="bi bi-trash"></i></button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                        <button type="button" class="btn btn-primary add-expect">
                                            <i class="bi bi-plus-circle"></i> Add Expectation
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <!-- Default empty block if no blocks exist -->
                            <div class="card mb-4 test-block">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="input-group">
                                        <span class="input-group-text">Block Name</span>
                                        <input type="text" class="form-control block-name" value="New Block">
                                    </div>
                                    <button type="button" class="btn btn-danger remove-block"><i class="bi bi-trash"></i></button>
                                </div>
                                <div class="card-body">
                                    <h5>Actions</h5>
                                    <div class="actions-container">
                                        <!-- Empty action container -->
                                    </div>
                                    <button type="button" class="btn btn-primary add-action">
                                        <i class="bi bi-plus-circle"></i> Add Action
                                    </button>
                                    
                                    <h5 class="mt-4">Expectations</h5>
                                    <div class="expects-container">
                                        <!-- Empty expects container -->
                                    </div>
                                    <button type="button" class="btn btn-primary add-expect">
                                        <i class="bi bi-plus-circle"></i> Add Expectation
                                    </button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" id="add-block">
                                <i class="bi bi-plus-circle"></i> Add Block
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</form>

<script>
    $(document).ready(function() {
        // Handle test execution
        $('.clarama-test-execute').click(function() {
            // Show loading indicator
            var loadingHtml = '<div id="test-execution-loading" class="alert alert-info">' +
                              '<i class="bi bi-hourglass-split"></i> Executing test... This may take a few moments.' +
                              '</div>';
            $('.container-fluid').prepend(loadingHtml);
            
            // Save the test first
            var testConfig = collectTestConfig();
            
            $.ajax({
                url: '/explorer/save/' + $(this).attr('url'),
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(testConfig),
                success: function() {
                    // Now execute the test
                    $.ajax({
                        url: '/explorer/execute/' + $('.clarama-test-execute').attr('url'),
                        type: 'GET',
                        success: function(response) {
                            $('#test-execution-loading').remove();
                            
                            var result = JSON.parse(response);
                            
                            if (result.status === 'success') {
                                var testResult = result.results;
                                var resultHtml = '<div id="test-execution-result" class="alert alert-' + 
                                                (testResult.success ? 'success' : 'danger') + ' alert-dismissible fade show">' +
                                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                                '<h5>' + (testResult.success ? 'Test Passed' : 'Test Failed') + '</h5>' +
                                                '<p>' + testResult.message + '</p>';
                                
                                // Add artifacts link if available
                                if (testResult.test_id && Object.keys(testResult.artifacts).length > 0) {
                                    resultHtml += '<p><a href="/explorer/view_artifacts/' + $('.clarama-test-execute').attr('url') + 
                                                 '?test_id=' + testResult.test_id + '" class="btn btn-primary">' +
                                                 '<i class="bi bi-camera-video"></i> View Test Artifacts</a></p>';
                                }
                                
                                resultHtml += '</div>';
                                
                                $('.container-fluid').prepend(resultHtml);
                            } else {
                                var errorHtml = '<div class="alert alert-danger alert-dismissible fade show">' +
                                               '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                               '<h5>Error Executing Test</h5>' +
                                               '<p>' + result.message + '</p>' +
                                               '</div>';
                                $('.container-fluid').prepend(errorHtml);
                            }
                        },
                        error: function(xhr, status, error) {
                            $('#test-execution-loading').remove();
                            var errorHtml = '<div class="alert alert-danger alert-dismissible fade show">' +
                                           '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                           '<h5>Error Executing Test</h5>' +
                                           '<p>' + error + '</p>' +
                                           '</div>';
                            $('.container-fluid').prepend(errorHtml);
                        }
                    });
                },
                error: function(xhr, status, error) {
                    $('#test-execution-loading').remove();
                    var errorHtml = '<div class="alert alert-danger alert-dismissible fade show">' +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '<h5>Error Saving Test</h5>' +
                                   '<p>' + error + '</p>' +
                                   '</div>';
                    $('.container-fluid').prepend(errorHtml);
                }
            });
        });
        
        // Function to collect test configuration
        function collectTestConfig() {
            // Collect all blocks
            var blocks = [];
            
            $('.test-block').each(function() {
                var blockName = $(this).find('.block-name').val();
                var actions = [];
                var expects = [];
                
                // Collect actions
                $(this).find('.action-item').each(function() {
                    var actionType = $(this).find('.action-type').val();
                    var action = {
                        type: actionType
                    };
                    
                    if (actionType === 'goto') {
                        action.url = $(this).find('.goto-url').val();
                    } else if (actionType === 'get_by_role') {
                        action.role = $(this).find('.get_by_role-role').val();
                        action.name = $(this).find('.get_by_role-name').val();
                        
                        // Collect role actions
                        var roleActions = [];
                        $(this).find('.role-action-item').each(function() {
                            var roleActionType = $(this).find('.role-action-type').val();
                            var roleAction = {
                                type: roleActionType
                            };
                            
                            if (roleActionType === 'fill') {
                                roleAction.value = $(this).find('.fill-value').val();
                            } else if (roleActionType === 'press') {
                                roleAction.key = $(this).find('.press-key').val();
                            }
                            
                            roleActions.push(roleAction);
                        });
                        
                        if (roleActions.length > 0) {
                            action.actions = roleActions;
                        }
                    } else if (actionType === 'page_locator') {
                        action.selector = $(this).find('.page_locator-selector').val();
                    }
                    
                    actions.push(action);
                });
                
                // Collect expectations
                $(this).find('.expect-item').each(function() {
                    var element = $(this).find('.expect-element').val();
                    var condition = $(this).find('.expect-condition').val();
                    var value = $(this).find('.expect-value').val();
                    var timeout = parseInt($(this).find('.expect-timeout').val());
                    
                    if (element) {
                        var expect = {
                            element: element,
                            condition: condition,
                            timeout: timeout
                        };
                        
                        if (condition !== 'visible') {
                            expect.value = value;
                        }
                        
                        expects.push(expect);
                    }
                });
                
                // Add block to blocks array if it has a name
                if (blockName) {
                    var block = {
                        name: blockName,
                        actions: actions
                    };
                    
                    if (expects.length > 0) {
                        block.expects = expects;
                    }
                    
                    blocks.push(block);
                }
            });
            
            // Create the test configuration object
            return {
                browser: $('#browser').val(),
                headless: $('#headless').val() === 'true',
                viewport: {
                    width: parseInt($('#viewport_width').val()),
                    height: parseInt($('#viewport_height').val())
                },
                timeout: parseInt($('#timeout').val()),
                screenshot: $('#screenshot').val(),
                video: $('#video').val(),
                trace: $('#trace').val(),
                blocks: blocks
            };
        }
        
        // Handle action type change to show/hide appropriate fields
        $(document).on('change', '.action-type', function() {
            var actionItem = $(this).closest('.action-item');
            var actionType = $(this).val();
            
            // Hide all field types
            actionItem.find('.goto-fields, .get_by_role-fields, .page_locator-fields').hide();
            
            // Show the selected field type
            actionItem.find('.' + actionType + '-fields').show();
        });
        
        // Handle role action type change
        $(document).on('change', '.role-action-type', function() {
            var actionItem = $(this).closest('.role-action-item');
            var actionType = $(this).val();
            
            // Hide all field types
            actionItem.find('.fill-fields, .press-fields').hide();
            
            // Show the selected field type (click has no fields)
            if (actionType !== 'click') {
                actionItem.find('.' + actionType + '-fields').show();
            }
        });
        
        // Handle expect condition change to enable/disable value field
        $(document).on('change', '.expect-condition', function() {
            var valueField = $(this).closest('.expect-item').find('.expect-value');
            if ($(this).val() === 'visible') {
                valueField.prop('disabled', true);
            } else {
                valueField.prop('disabled', false);
            }
        });
        
        // Add new block
        $('#add-block').click(function() {
            var newBlock = `
                <div class="card mb-4 test-block">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="input-group">
                            <span class="input-group-text">Block Name</span>
                            <input type="text" class="form-control block-name" value="New Block">
                        </div>
                        <button type="button" class="btn btn-danger remove-block"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="card-body">
                        <h5>Actions</h5>
                        <div class="actions-container">
                            <!-- Empty action container -->
                        </div>
                        <button type="button" class="btn btn-primary add-action">
                            <i class="bi bi-plus-circle"></i> Add Action
                        </button>
                        
                        <h5 class="mt-4">Expectations</h5>
                        <div class="expects-container">
                            <!-- Empty expects container -->
                        </div>
                        <button type="button" class="btn btn-primary add-expect">
                            <i class="bi bi-plus-circle"></i> Add Expectation
                        </button>
                    </div>
                </div>
            `;
            $('#test-blocks-container').append(newBlock);
        });
        
        // Add new action
        $(document).on('click', '.add-action', function() {
            var actionsContainer = $(this).siblings('.actions-container');
            var newAction = `
                <div class="card mb-3 action-item">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <select class="form-control action-type">
                            <option value="goto" selected>goto</option>
                            <option value="get_by_role">get_by_role</option>
                            <option value="page_locator">page_locator</option>
                        </select>
                        <button type="button" class="btn btn-danger remove-action"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic fields based on action type -->
                        <div class="goto-fields">
                            <div class="form-group">
                                <label>URL</label>
                                <input type="text" class="form-control goto-url" value="">
                            </div>
                        </div>
                        
                        <div class="get_by_role-fields" style="display: none;">
                            <div class="form-group mb-3">
                                <label>Role</label>
                                <input type="text" class="form-control get_by_role-role" value="">
                            </div>
                            <div class="form-group mb-3">
                                <label>Name</label>
                                <input type="text" class="form-control get_by_role-name" value="">
                            </div>
                            
                            <h6>Role Actions</h6>
                            <div class="role-actions-container">
                                <!-- Empty role actions container -->
                            </div>
                            <button type="button" class="btn btn-sm btn-primary add-role-action">
                                <i class="bi bi-plus-circle"></i> Add Role Action
                            </button>
                        </div>
                        
                        <div class="page_locator-fields" style="display: none;">
                            <div class="form-group">
                                <label>Selector</label>
                                <input type="text" class="form-control page_locator-selector" value="">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            actionsContainer.append(newAction);
        });
        
        // Add new role action
        $(document).on('click', '.add-role-action', function() {
            var roleActionsContainer = $(this).siblings('.role-actions-container');
            var newRoleAction = `
                <div class="card mb-2 role-action-item">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <select class="form-control role-action-type">
                                <option value="click" selected>click</option>
                                <option value="fill">fill</option>
                                <option value="press">press</option>
                            </select>
                            <button type="button" class="btn btn-danger remove-role-action"><i class="bi bi-trash"></i></button>
                        </div>
                        
                        <div class="fill-fields" style="display: none;">
                            <div class="form-group">
                                <label>Value</label>
                                <input type="text" class="form-control fill-value" value="">
                            </div>
                        </div>
                        
                        <div class="press-fields" style="display: none;">
                            <div class="form-group">
                                <label>Key</label>
                                <input type="text" class="form-control press-key" value="">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            roleActionsContainer.append(newRoleAction);
        });
        
        // Add new expectation
        $(document).on('click', '.add-expect', function() {
            var expectsContainer = $(this).siblings('.expects-container');
            var newExpect = `
                <div class="row mb-3 expect-item">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Element Selector</label>
                            <input type="text" class="form-control expect-element" value="">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Condition</label>
                            <select class="form-control expect-condition">
                                <option value="visible" selected>Is Visible</option>
                                <option value="contains">Contains Text</option>
                                <option value="has_value">Has Value</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Value</label>
                            <input type="text" class="form-control expect-value" disabled>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Timeout (ms)</label>
                            <input type="number" class="form-control expect-timeout" value="5000">
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-expect mb-2"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
            expectsContainer.append(newExpect);
        });
        
        // Remove block
        $(document).on('click', '.remove-block', function() {
            // Don't remove if it's the last block
            if ($('.test-block').length > 1) {
                $(this).closest('.test-block').remove();
            } else {
                alert('You must have at least one test block.');
            }
        });
        
        // Remove action
        $(document).on('click', '.remove-action', function() {
            $(this).closest('.action-item').remove();
        });
        
        // Remove role action
        $(document).on('click', '.remove-role-action', function() {
            $(this).closest('.role-action-item').remove();
        });
        
        // Remove expectation
        $(document).on('click', '.remove-expect', function() {
            $(this).closest('.expect-item').remove();
        });
        
        // Save button click handler
        $('.clarama-test-save').click(function() {
            var testConfig = collectTestConfig();
            
            // Save the configuration
            $.ajax({
                url: '/explorer/save/' + $(this).attr('url'),
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(testConfig),
                success: function(response) {
                    console.log('Test configuration saved successfully');
                    // Show success message
                    $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      'Test configuration saved successfully!' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>').prependTo('.container-fluid').delay(3000).fadeOut();
                },
                error: function(error) {
                    console.error('Error saving test configuration:', error);
                    // Show error message
                    $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                      'Error saving test configuration!' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>').prependTo('.container-fluid');
                }
            });
        });
    });
</script>

{% include theme("web/file_footer.html") %}