<li id="{{ (task_topic ~ '_stream_' ~ stream ~ '_step') }}_{{ task_index }}" step="{{ task_index }}"
    class="row bg-white text-dark clarama-cell-item"
    steptype="{{ task_step['type'] }}"
>
    <div class="panel col-step-bar cell-panel col-lg-1 d-flex flex-column position-relative bg-{{ 'cell' if task_last else 'resultcell' }} text-light draggable-heading"
         style="padding:0">
        <hr class="faded" style="margin: 0"/>
        <div class="container-fluid pt-2">
            <div class="row g-1 align-items-center">
                <div class="col-auto">
                    <button type="button" class="btn step-label px-2 py-1">{{ task_index }}</button>
                </div>
                <div class="col text-end">
                    <div class="btn-group">
                        <button type="button" class="btn celleditrun p-1" data-bs-toggle="tooltip"
                                data-bs-placement="bottom" title="Run this step">
                            <i class="fs-5 bi bi-play-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <div class="cell-timing container-fluid px-0"></div>
                </div>
            </div>
        </div>
        <div class="cell-spin" style="opacity: 0">
            <div class="d-flex justify-content-center spinner-border text-info position-absolute start-50" role="status"
                 style="width: 4rem; height: 4rem;"></div>
        </div>
    </div>
    <div class="col-remainder" style="padding:0px;">
        <div class="cell-hover-target" data-task-index="{{ task_index }}" aria-hidden="true"></div>

        <div class="cell-toolbar-floating d-none" id="cell_toolbar_floating_{{ task_index }}">
            <div class="container-fluid px-1">
                <div class="row flex-nowrap align-items-center g-1" style="padding:0;">
                    <div class="col">
                        <input type="text" id="loop-iterable-{{ task_index }}"
                                loop-id="{{ task_index }}"
                                class="form-control loop-iterable loop-inactive"
                                value="{%- if step is defined -%}{{ step['loop-iterable'] }}{%- endif -%}">
                    </div>
                    {% include theme("explorer/files/_cell_insert.html") %}
                    <div class="col-auto hoverover auto-hover"
                        id="task_toolbar_{{ stream }}_{{ task_index }}_trash"
                        opacity="0.04"
                        style="opacity: 0.04; padding-left: 0;">
                        <button type="button" class="btn delete_step" data-bs-toggle="tooltip"
                                data-bs-placement="bottom" title="Delete this step"
                                style="--bs-btn-padding-y: 0.1rem; --bs-btn-padding-x: 0.25rem;">
                            <i class="bi bi-trash" style="font-size: 1.3rem;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="loop loop-edge loop-hidden loop-{{ task_index }}">&nbsp;</div>
            <div class="row" data-task-index="{{ task_index }}">
                <div class="col loop-left loop-hidden loop-{{ task_index }}">
                    <div class="loop loop-left loop-height">&nbsp;</div>
                </div>

                <div class="col-12 cell-split">
                    <div class="content-row" data-task-index="{{ task_index }}">
                        <!-- Left Half -->
                        <div class="left-content" id="left_content_{{ task_index }}">
                            <!-- the Editing -->
                            <div id="step_{{ stream }}_{{ task_index }}"
                                 class="clarama-post-embedded cell-editor"
                                 post_json="json_{{ task_index }}"
                                 url="{{ call('clarama_content.content_template_render','explorer/steps/' ~ task_step['type'] ~ '_edit') }}?loop_index={{ task_index }}">
                            </div>
                            <!-- the Results -->
                            <div class="container-fluid cell-response">
                                <div id="results_{{ task_index }}" class="cell-results"></div>
                            </div>
                        </div>

                        <!-- Right Half (insights) -->
                        <div class="right-content d-none" id="right_content_{{ task_index }}">
                            {% include theme("explorer/files/_cell_insights.html") %}
                        </div>

                        <button
                                type="button" class="insights-toggle-bar" data-task-index="{{ task_index }}"
                                data-bs-toggle="tooltip" data-bs-placement="left"
                                title="Insights (Ctrl-\\)" aria-label="Toggle insights (Ctrl-\\)" tabindex="0">
                            <i class="bi bi-lightbulb-off"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="loop loop-edge loop-hidden loop-{{ task_index }}">&nbsp;</div>
        </div>
    </div>
</li>

<script>
    function toggle_loop(elem) {
        var val = (elem.val()).trim();

        loop_id = elem.attr('loop-id');

        //console.log("LOOP" + elem.attr('id'));

        //console.log('LOOP .loop-' + loop_id + ' : ' + val);

        //console.log($('.loop-' + loop_id));

        if (val == '') {
            elem.addClass('loop-inactive');
            elem.removeClass('loop-active');
            $('.loop-' + loop_id).addClass("loop-hidden");
            $('.loop-' + loop_id).removeClass("loop-show");
        } else {
            elem.addClass('loop-active');
            elem.removeClass('loop-inactive');
            $('.loop-' + loop_id).removeClass("loop-hidden");
            $('.loop-' + loop_id).addClass("loop-show");
        }
    }

    $(document).ready(() => {
        $('.loop-iterable').each(function () {
            toggle_loop($(this));
        });

        $('.loop-iterable').bind('keypress keydown keyup', function (e) {
            if (e.keyCode == 13) { // enter key
                e.preventDefault();
            }
            toggle_loop($(this));
        });

        $("input").off("change");
        $("input").on("change", function () {
            toggle_loop($(this));
        });

        initializeCellCopyPaste();
    });

    (function () {
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function setupFloatingToolbarForCell($cell) {
            const $colRem   = $cell.find('.col-remainder').first();
            const $target   = $colRem.find('.cell-hover-target');
            const taskIndex = $target.data('task-index');
            const $float    = $colRem.find('#cell_toolbar_floating_' + taskIndex);

            if ($float.length === 0 || $target.length === 0) return;

            let hoverLock = false;   // stays visible while mouse is over either target or floating area

            function positionAtMouse(e) {
                const rect   = $colRem[0].getBoundingClientRect();
                const fw     = $float.outerWidth();
                const fh     = $float.outerHeight();
                const maxX   = Math.max(0, rect.width  - fw);
                const maxY   = Math.max(0, rect.height - fh);

                // Centre the bar at the cursor, but clamp so it remains fully visible
                const x = clamp(e.clientX - rect.left - fw / 2, 0, maxX);
                const y = clamp(e.clientY - rect.top  - fh / 2, 0, maxY);

                $float.css({ left: x + 'px', top: y + 'px' });
            }

            function show(e) {
            $float.removeClass('d-none');
                positionAtMouse(e);
            }

            function hide() {
                if (!hoverLock) $float.addClass('d-none');
            }

            // Show & follow mouse while in the thin top band
            $target.on('mouseenter', show);
            $target.on('mousemove', positionAtMouse);
            $target.on('mouseleave', function () { setTimeout(hide, 80); });

            // Keep visible while interacting with the floating toolbar itself
            $float.on('mouseenter', function () { hoverLock = true; });
            $float.on('mouseleave', function () { hoverLock = false; hide(); });
        }

        // Initialise for all cells on load and whenever cells are (re)rendered
        $(document).ready(function () {
            $('li.clarama-cell-item').each(function () {
                setupFloatingToolbarForCell($(this));
            });
        });
    })();
</script>
  