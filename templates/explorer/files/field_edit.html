<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center bg-secondary text-white rounded-top px-3 py-2 mb-2">
        <div class="col-12 col-md-6 d-flex align-items-center gap-4">
            <label class="form-check-label" for="name">Name</label>
            <input id="name" required name="name" type="text" class="form-control clarama-field"
                   autocomplete="on"
                   placeholder="field name"
                   value="{{ get(field_config,'name','') }}" {% include theme("explorer/files/field_tooltip.html") %} />

            <div class="form-check form-switch">
                <input class="form-check-input clarama-field clarama-now-field" fieldtype="html"
                       type="checkbox" id="required" name="required"
                        {% if get(field_config,'required','') | lower == 'true' %}
                       checked {% endif %} {% include theme("explorer/files/field_tooltip.html") %}>
                <label class="form-check-label" for="required">Required</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input clarama-field clarama-now-field" fieldtype="html"
                       type="checkbox" id="readonly" name="readonly"
                        {% if get(field_config,'readonly','') | lower == 'true' %}
                       checked {% endif %} {% include theme("explorer/files/field_tooltip.html") %}>
                <label class="form-check-label nowrap" for="readonly">Read-Only</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input clarama-field clarama-now-field" fieldtype="html"
                       type="checkbox" id="sticky" name="sticky"
                        {% if get(field_config,'sticky','') | lower == 'true' %}
                       checked {% endif %} {% include theme("explorer/files/field_tooltip.html") %}>
                <label class="form-check-label nowrap" for="sticky">Sticky</label>
            </div>
        </div>
        <button style="background-color: rgba(255, 255, 255, 0); border-color: rgba(255, 255, 255, 0); color: white;">
            <i id="save" class="fs-3 bi bi-floppy" onclick="save_field();" url="{{ file_url }}" title="Save"></i>
        </button>
    </div>

    <!-- Preview at the top -->
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="m-0">Field Preview</h5>
        </div>
        <div class="card-body">
            <div id="dependencies-preview" class="mb-2"></div>
            <div id="list-columns-warning" class="alert alert-warning py-2 px-3 d-none" role="alert"
                 style="margin-bottom:8px;">
                Preview note: For List fields, at least two columns must be supplied.
            </div>
            <div id="preview" class="clarama-embedded" url="{{ embedded_url(filename=file_url) }}"></div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="fieldEditTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-fieldtype" data-bs-toggle="tab" data-bs-target="#pane-fieldtype"
                    type="button" role="tab" aria-controls="pane-fieldtype" aria-selected="true">Field Type
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-options" data-bs-toggle="tab" data-bs-target="#pane-options" type="button"
                    role="tab" aria-controls="pane-options" aria-selected="false">Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-data" data-bs-toggle="tab" data-bs-target="#pane-data" type="button"
                    role="tab" aria-controls="pane-data" aria-selected="false">Data
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dependencies" data-bs-toggle="tab" data-bs-target="#pane-dependencies"
                    type="button" role="tab" aria-controls="pane-dependencies" aria-selected="false">Dependent Fields
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-custom" data-bs-toggle="tab" data-bs-target="#pane-custom"
                    type="button" role="tab" aria-controls="pane-custom" aria-selected="false">Custom
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-suggestions" data-bs-toggle="tab" data-bs-target="#pane-suggestions"
                    type="button" role="tab" aria-controls="pane-suggestions" aria-selected="false">Suggestions
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 rounded-bottom card-body" id="fieldEditTabsContent">
        <!-- Field Type Pane -->
        <div class="tab-pane fade show active" id="pane-fieldtype" role="tabpanel" aria-labelledby="tab-fieldtype">
            <div class="container-fluid">
                <div class="row g-3 my-2">
                    {# Build a sortable list of (key, ftype) and sort by group then name #}
                    {% set ft_list = [] %}
                    {% for k, v in fieldtypes.items() %}
                        {% set _ = ft_list.append({'key': k, 'v': v, 'group': v.get('group',''), 'name': v.get('name','')}) %}
                    {% endfor %}
                    {% for item in ft_list|sort(attribute='group')|sort(attribute='name') %}
                        {% set key = item.key %}
                        {% set ftype = item.v %}
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <label id="field_{{ key }}" key="{{ key }}"
                                   class="btn w-100 {% if field_config['type'] == key %} clicked btn-c2 {% else %} btn-light {% endif %} field">
                                <i class="bi fs-4 {{ ftype['icon'] }} w-100"></i>
                                <div class="text-center mt-1"><b>{{ ftype['name'] }}</b></div>
                            </label>
                            <p class="text-center mt-1 small">{{ ftype['description'] }}</p>
                        </div>
                    {% endfor %}
                </div>


            </div>
        </div>


        <!-- Dependencies Pane -->
        <div class="tab-pane fade" id="pane-dependencies" role="tabpanel" aria-labelledby="tab-dependencies">
            {% set deps = get(field_config, 'dependencies', []) %}
            <div class="mb-2">
                <p>
                    This feature is only for testing purposes, so you can test what happens right here with multiple
                    other field inputs. The dependencies will be saved along with the field, but will not add
                    automatically to a slate or task.
                </p>
                <p>
                    Select a field file in the box below, then click the [+] button to add to the list
                </p>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="dependency-file-input"
                           placeholder="pick a .field.yaml">
                    <button type="button" class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                            data-bs-target="#browseFileModal" filters="*.field.yaml" inputId="dependency-file-input"
                            title="Browse .field.yaml"><i class="bi bi-folder2-open"></i></button>
                    <button type="button" class="btn btn-outline-primary" id="add-dependency"><i
                            class="bi bi-plus-lg"></i></button>
                </div>
                <label class="form-label">Dependencies (fields this field depends on)</label>
                <ul id="dependencies-list" class="list-group">
                    {% for d in deps %}
                        <li class="list-group-item d-flex align-items-center dep-item" draggable="true">
                            <span class="dep-handle bi bi-grip-vertical me-2" title="Drag to reorder"
                                  style="cursor: grab;"></span>
                            <span class="dep-text flex-grow-1">{{ d }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-dep"><i
                                    class="bi bi-x"></i></button>
                        </li>
                    {% endfor %}
                </ul>
                <input type="hidden" id="dependencies-json" value='{{ deps | tojson | safe }}'>
                <div class="form-text mt-2">Use the add button to include a dependency. Click X to remove.</div>
            </div>
        </div>

        <!-- Data Pane -->
        <div class="tab-pane fade" id="pane-data" role="tabpanel" aria-labelledby="tab-data">
            {% set data_cfg = get(field_config, 'data', {}) %}
            {% set has_options = data_cfg and 'options' in data_cfg %}
            {% set mode_manual = has_options %}
            <div class="mb-3">
                <label class="form-label me-3">Data Mode</label>
                {% set is_list = (get(field_config,'type','') == 'list') %}
                {% set has_columns = data_cfg and ('columns' in data_cfg) %}
                <div class="btn-group" role="group" aria-label="Data Mode">
                    <input type="radio" class="btn-check" name="data-mode" id="data-mode-manual" autocomplete="off"
                           {% if mode_manual %}checked{% endif %}>
                    <label class="btn btn-outline-secondary" for="data-mode-manual">Manually Entered</label>

                    <input type="radio" class="btn-check" name="data-mode" id="data-mode-remote" autocomplete="off"
                           {% if (not mode_manual) %}checked{% endif %}>
                    <label class="btn btn-outline-secondary" for="data-mode-remote">Remote</label>
                </div>
            </div>

            <!-- Manual Data -->
            <div id="manual-data" class="mb-3" style="display: {% if mode_manual %}block{% else %}none{% endif %};">
                {# Normalize options into a list of {id, value} dicts to ensure iterability #}
                {% set _opts = (data_cfg.get('options') if data_cfg and ('options' in data_cfg) else []) %}
                {% if _opts is mapping %}
                    {% set options_list = [] %}
                    {% for k, v in _opts.items() %}
                        {% do options_list.append({'id': k, 'value': v}) %}
                    {% endfor %}
                {% elif _opts is sequence and _opts is not string %}
                    {% set options_list = [] %}
                    {% for item in _opts %}
                        {% if item is mapping %}
                            {% set _id = item.get('id', item.get('key', '')) %}
                            {% set _val = item.get('value', item.get('val', item.get('label', ''))) %}
                            {% do options_list.append({'id': _id, 'value': _val}) %}
                        {% else %}
                            {% do options_list.append({'id': item, 'value': item}) %}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    {% set options_list = [] %}
                {% endif %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="form-text mt-2">Manually enter values you would like to show in the dropdown.
                        <br>
                        <br>
                        <b>Note:</b> If you are using a remote source, the values here will be ignored.
                    </div>
                    <label class="form-label m-0">Manual Options</label>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-option-row"><i
                            class="bi bi-plus-lg me-1"></i>Add Row
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="manual-options-table">
                        <thead>
                        <tr>
                            <th style="width: 25%">Id</th>
                            <th>Value</th>
                            <th style="width: 48px"></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for opt in options_list %}
                            <tr>
                                <td><input type="text" class="form-control option-id" value="{{ opt.get('id', '') }}">
                                </td>
                                <td><input type="text" class="form-control option-value"
                                           value="{{ opt.get('value', '') }}"></td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-option"><i
                                            class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        {% endfor %}
                        {% if options_list|length == 0 %}
                            <tr>
                                <td><input type="text" class="form-control option-id" value=""></td>
                                <td><input type="text" class="form-control option-value" value=""></td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-option"><i
                                            class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Remote Data (simplified) -->
            <div id="remote-data" style="display: {% if mode_manual %}none{% else %}block{% endif %};">
                {% set src = data_cfg.get('source', '') if data_cfg else '' %}
                {% set params = data_cfg.get('params', {}) if data_cfg else {} %}
                {% set query = params.get('query', '') %}

                <label class="form-label">Source</label>
                <div class="input-group mb-2 w-100">
                    <input id="field_data_source" type="text" class="form-control source-input-field"
                           placeholder="relative path to source/task/table/csv" value="{{ src }}">
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                            data-bs-target="#browseFileModal" filters="*.table.yaml|*.task.yaml|*.source.yaml|*.csv"
                            inputId="field_data_source" title="Pick source"><i class="bi bi-folder2-open"></i></button>
                    {% if src %}
                        <a href="{{ src }}" target="_blank" class="btn btn-outline-info" title="Open Source"><i
                                class="bi bi-pen"></i></a>
                    {% else %}
                        <button type="button" class="btn btn-outline-info" disabled title="Open Source"><i
                                class="bi bi-pen"></i></button>
                    {% endif %}
                </div>

                <label class="form-label">Query
                    <button type="button" class="btn btn-link btn-sm p-0 align-baseline ms-1" title="Query help"
                            data-bs-toggle="modal" data-bs-target="#queryHelpModal">
                        <i class="bi bi-question-circle"></i>
                    </button>
                </label>
                <div id="field_data_query" class="source-editor form-control clarama-editor-field" editor="sql"
                     style="min-height: 0; height: 160px;"
                     placeholder="Enter query (SQL/Path/YAML)">{{ query }}</div>
                <div class="form-text mt-2">The first column is used as the ID, the second is used as the value. It does
                    not matter what the columns are called<br/><br/>
                </div>


                <!-- Quick Insert Global Field Expression -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0">Global Fields</h6> take dependent field values, if found, and insert into the
                        Query above prior to execution
                    </div>

                    {% include theme("explorer/files/field_edit_fields.html") %}
                </div>

                <script type="text/javascript">$(function () {
                    $('#field_data_query').editor();
                });</script>

                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="btn-preview-remote"><i
                                class="bi bi-eye me-1"></i>Preview Result
                        </button>
                        <pre class="mt-2"><code id="clarama-query-result"></code></pre>
                    </div>
                </div>

                <div class="table-responsive mt-2" id="remote-preview" style="display:none;">
                    <table class="table table-sm table-striped mb-0" id="remote-preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <input type="hidden" id="data_text" value=""> <!-- holds JSON/YAML generated for backend -->
        </div>

        <!-- Options Pane (merged with Settings) -->
        <div class="tab-pane fade" id="pane-options" role="tabpanel" aria-labelledby="tab-options">
            <div class="mb-3">
                <div class="col">
                    <label class="form-label" for="placeholder">Placeholder</label>
                    <input id="placeholder" name="placeholder" type="text" class="form-control clarama-field"
                           placeholder="placeholder value"
                           value="{{ get(field_config,'placeholder','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                </div>

                <div class="col">
                    <label class="form-label" for="pattern">Pattern</label>
                    <input id="pattern" name="pattern" type="text" class="form-control clarama-field"
                           placeholder="regular expression (e.g., ^[A-Z]{3}-\\d{4}$)"
                           value="{{ get(field_config,'pattern','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    <div class="form-text">Optional input validation regex pattern.</div>
                </div>

                <div class="col">
                    <label class="form-label" for="autocomplete">Autocomplete</label>
                    <input id="autocomplete" name="autocomplete" type="text" class="form-control clarama-field"
                           placeholder="on | off | email | username | name | organization | ..."
                           value="{{ get(field_config,'autocomplete','on') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    <div class="form-text">HTML autocomplete attribute value. Use "off" to disable or a hint like
                        "email".
                    </div>
                </div>

                <div class="col">
                    <label class="form-label">Description</label>
                    <textarea id="description" name="description" class="form-control clarama-field"
                              autocomplete="on" rows="4"
                              placeholder="description" {% include theme("explorer/files/field_tooltip.html") %}>{{ get(field_config,'description','') }}</textarea>
                </div>
                <div class="col">
                    <label class="form-label">Default</label>
                    <input id="default" name="default" type="text" class="form-control clarama-field"
                           placeholder="default value"
                           value="{{ get(field_config,'default','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    <div class="form-text">For checkboxes, use True for checked (converted to lowercase string
                        'true').
                    </div>
                </div>
                <div class="col" id="filters_group"
                     style="display: {% if get(field_config,'type','') in ['c2file','browse'] %}block{% else %}none{% endif %};">
                    <label class="form-label">Filters (for Browse File)</label>
                    <input id="filters" name="filters" type="text" class="form-control clarama-field"
                           placeholder="e.g., *.field.yaml|*.task.yaml|*.source.yaml|*.csv"
                           value="{{ get(field_config,'filters','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    <div class="form-text">Pipe-separated list of file patterns. Example: *.field.yaml|*.task.yaml</div>
                </div>
                <div class="row align-items-start">
                    <div class="col align-items-start">
                        <label class="form-label">Minimum</label>
                        <input id="minimum" name="minimum" type="number"
                               class="form-control clarama-field clarama-delay-field" fieldtype="html"
                               placeholder="0"
                               value="{{ get(field_config,'minimum','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    </div>
                    <div class="col">
                        <label class="form-label">Maximum</label>
                        <input id="maximum" name="maximum" type="number"
                               class="form-control clarama-field clarama-delay-field" fieldtype="html"
                               placeholder="100"
                               value="{{ get(field_config,'maximum','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    </div>
                    <div class="col">
                        <label class="form-label">Step</label>
                        <input id="step" name="step" type="number"
                               class="form-control clarama-field clarama-delay-field"
                               fieldtype="html" placeholder="1"
                               value="{{ get(field_config,'step','') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    </div>
                    <div class="col">
                        <label class="form-label">Size</label>
                        <input id="size" name="size" type="number"
                               class="form-control clarama-field clarama-delay-field"
                               fieldtype="html" placeholder="4"
                               value="{{ get(field_config,'size','4') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    </div>
                    <div class="col">
                        <label class="form-label">Spacing</label>
                        <input id="spacing" name="spacing" type="number"
                               class="form-control clarama-field clarama-delay-field" fieldtype="html"
                               placeholder="2"
                               value="{{ get(field_config,'spacing','3') }}" {% include theme("explorer/files/field_tooltip.html") %}/>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Pane (per-field-type options) -->
        <div class="tab-pane fade" id="pane-custom" role="tabpanel" aria-labelledby="tab-custom">
            <div class="mb-3">
                <div id="custom-dynamic-container" class="custom-dynamic-container"></div>
            </div>

            <!-- Hidden templates for dynamic injection -->
            <template id="tpl-custom-string">
                {% include theme('explorer/files/_field_custom_string.html') %}
            </template>
            <template id="tpl-custom-number">
                {% include theme('explorer/files/_field_custom_number.html') %}
            </template>
            <template id="tpl-custom-datetime">
                {% include theme('explorer/files/_field_custom_datetime.html') %}
            </template>
            <template id="tpl-custom-date">
                {% include theme('explorer/files/_field_custom_date.html') %}
            </template>
            <template id="tpl-custom-time">
                {% include theme('explorer/files/_field_custom_time.html') %}
            </template>
            <template id="tpl-custom-list">
                {% include theme('explorer/files/_field_custom_list.html') %}
            </template>
            <template id="tpl-custom-checkbox">
                {% include theme('explorer/files/_field_custom_checkbox.html') %}
            </template>
            <template id="tpl-custom-select">
                {% include theme('explorer/files/_field_custom_select.html') %}
            </template>
            <template id="tpl-custom-select_multiple">
                {% include theme('explorer/files/_field_custom_select_multiple.html') %}
            </template>
            <template id="tpl-custom-file">
                {% include theme('explorer/files/_field_custom_file.html') %}
            </template>
            <template id="tpl-custom-textarea">
                {% include theme('explorer/files/_field_custom_textarea.html') %}
            </template>
            <template id="tpl-custom-tagcloud">
                {% include theme('explorer/files/_field_custom_tagcloud.html') %}
            </template>
            <template id="tpl-custom-daterange">
                {% include theme('explorer/files/_field_custom_daterange.html') %}
            </template>
        </div>

        <!-- Suggestions Pane -->
        <div class="tab-pane fade" id="pane-suggestions" role="tabpanel" aria-labelledby="tab-suggestions">
            {% set suggestions = get(field_config,'suggestions',[]) %}
            {% if suggestions is string %}
                {% set suggestions = [suggestions] %}
            {% endif %}
            <label class="form-label">Suggestions (one per line)</label>
            <textarea id="suggestions" class="form-control clarama-field" rows="6"
                      placeholder="Enter suggestion per line">{% for s in suggestions %}{{ s }}
            {% endfor %}</textarea>
            <div class="form-text">Shown as typeahead or helper list where supported.</div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var key = "{{ get(field_config,'type','string') }}";

    function getEditorValue(id) {
        try {
            var ed = ace.edit(id);
            if (ed && ed.getValue) {
                return ed.getValue();
            }
        } catch (e) {
        }
        return $("#" + id).val();
    }

    $(function () {
        function renderCustomPane(t) {
            try {
                var k = String(t || '').toLowerCase();
                var tplId = 'tpl-custom-string';
                tplId = 'tpl-custom-' + k;
                var tpl = document.getElementById(tplId);
                console.log(tpl);
                var html = tpl ? tpl.innerHTML : '';

                $('#custom-dynamic-container').html(html);
            } catch (e) { /* ignore */
                flash("Error loading options", "danger");
                console.error(e);
            }
        }

        // Click handlers
        $(document).on('click', '.field', function () {
            $(".field").removeClass("clicked btn-c2").addClass("btn-light");
            key = $(this).attr("key");
            $(this).addClass("clicked btn-c2").removeClass("btn-light");
            // Toggle custom mode availability for list type

            // Show/Hide filters field for browse-like types (c2file, browse)
            if (key === 'c2file' || key === 'browse') {
                $('#filters_group').show();
            } else {
                $('#filters_group').hide();
            }
            // Render custom options dynamically
            renderCustomPane(key);
            schedule_update_preview(false, 'field type changed', 0);
        });

        // Any field change (including dependency dropdowns rendered with .clarama-field) triggers preview refresh
        // But do NOT refresh if the change originated inside the preview or any dependency preview to avoid loops.
        $(document).on('focusout change', '.clarama-field, #field_data_source', function (e) {
            try {
                var $t = $(e.target);
                // Main preview container
                var inMainPreview = $t.closest('#preview').length > 0;
                // Dependency previews container or individual dependency blocks
                var inDepsPreviewArea = $t.closest('#dependencies-preview').length > 0 || $t.closest('.clarama-post-embedded').length > 0;
                if (inMainPreview || inDepsPreviewArea) {
                    return; // Skip refresh if interaction is inside preview areas
                }
            } catch (err) { /* ignore and fall through to update */
            }
            schedule_update_preview(false, 'field form changed');
        });
        // React to editor changes as well
        try {
            var queryEditor = ace.edit('field_data_query');
            queryEditor.session.on('change', function (e) {
                // Editor is outside preview containers; safe to refresh
                schedule_update_preview(false, 'query editor changed');
            });
            // Quick insert handler
            $(document).on('click', '#gfe_insert', function () {
                try {
                    var from = ($('#gfe_dep_field').find('option:selected').val() || $('#gfe_dep_field').val() || '').trim();
                    var layout = $('#gfe_layout').val() || '';
                    var to = ($('#gfe_to').val() || '').trim();
                    var ext = ($('#gfe_ext').val() || '').trim();
                    if (!from) {
                        flash('Please enter a dependent field (from).', 'warning');
                        return;
                    }
                    // Build token parts
                    var token = '';
                    if (to) {
                        token = from.toLowerCase() + '=>' + to + (layout || '');
                    } else {
                        token = from.toLowerCase() + (layout || '');
                    }
                    if (ext) {
                        token += ':' + ext;
                    }
                    var text = '[[' + token + ']]';
                    // Insert at current cursor
                    var pos = queryEditor.getCursorPosition();
                    queryEditor.session.insert(pos, text);
                    queryEditor.focus();
                } catch (e) { /* ignore */
                }
            });

            // Resultant Substitution preview (Global Fields box)
            var _gfeTimer = null;

            function buildGfeToken() {
                var from = ($('#gfe_dep_field').find('option:selected').val() || $('#gfe_dep_field').val() || '').trim();
                var layout = $('#gfe_layout').val() || '';
                var to = ($('#gfe_to').val() || '').trim();
                var ext = ($('#gfe_ext').val() || '').trim();
                if (!from) return '';
                var token = to ? (from.toLowerCase() + '=>' + to + (layout || '')) : (from.toLowerCase() + (layout || ''));
                if (ext) token += ':' + ext;
                return '[[ ' + token + ' ]]';
            }

            function gfeCollectValues() {
                // Prefer global helper if available
                if (typeof get_field_values === 'function') {
                    try {
                        return get_field_values({}, true, undefined) || {};
                    } catch (e) {
                    }
                }
                // Fallback: no values
                return {};
            }

            function updateGfePreviewDebounced() {
                if (_gfeTimer) clearTimeout(_gfeTimer);
                _gfeTimer = setTimeout(updateGfePreview, 300);
            }

            function updateGfePreview() {
                var expr = buildGfeToken();
                var $expr = $('#gfe_result_expr');
                var $val = $('#gfe_result_value');
                if (!$expr.length || !$val.length) return;
                if (!expr) {
                    $expr.text('');
                    $val.text('');
                    return;
                }
                // Show expression immediately, and loading indicator for value
                $expr.text(expr);
                $val.text('…');
                $.ajax({
                    url: '/web/preview_global_field',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        expression: expr,
                        fields: JSON.stringify(gfeCollectValues())
                    },
                    success: function (data) {
                        try {
                            var outExpr = (data && data.expression) != null ? data.expression : expr;
                            var outRes = (data && data.result) != null ? data.result : '';
                            $expr.text(String(outExpr));
                            $val.text(String(outRes));
                        } catch (e) {
                            $val.text('error parsing response');
                        }
                    },
                    error: function (xhr) {
                        var msg = xhr && (xhr.responseText || xhr.statusText || xhr.status) || 'error';
                        $val.text(String(msg));
                    }
                });
            }

            $(document).on('change input', '#gfe_dep_field, #gfe_to, #gfe_layout, #gfe_ext', function () {
                updateGfePreviewDebounced();
            });
            // Also update when dependencies list changes, as it can change available values
            $(document).on('click', '#add-dependency, .remove-dep', function () {
                setTimeout(updateGfePreviewDebounced, 0);
            });
            $(document).on('keyup change', '#dependency-file-input', function () {
                setTimeout(updateGfePreviewDebounced, 0);
            });
            // Initial preview
            setTimeout(updateGfePreviewDebounced, 200);

            // When user clicks within a [[ ... ]] token, open the Global Field Editor modal
            {#queryEditor.container.addEventListener('mouseup', function () {#}
            {#     setTimeout(function () {#}
            {#         try {#}
            {#             var pos = queryEditor.getCursorPosition();#}
            {#             var line = queryEditor.session.getLine(pos.row);#}
            {#             // find closest [[ ... ]] spanning the cursor column#}
            {#             var start = line.lastIndexOf('[[', pos.column);#}
            {#             var end = line.indexOf(']]', pos.column);#}
            {#             if (start !== -1 && end !== -1 && end > start) {#}
            {#                 var inside = line.substring(start + 2, end).trim();#}
            {#                 if (inside.length > 0) {#}
            {#                     openGlobalFieldEditorForToken(inside, function (newToken) {#}
            {#                         // replace only this occurrence within the line#}
            {#                         var before = line.substring(0, start);#}
            {#                         var after = line.substring(end + 2);#}
            {#                         var replacement = '[[ ' + newToken.trim() + ' ]]';#}
            {#                         var newLine = before + replacement + after;#}
            {#                         queryEditor.session.replace({#}
            {#                             start: {row: pos.row, column: 0},#}
            {#                             end: {row: pos.row, column: line.length}#}
            {#                         }, newLine);#}
            {#                     });#}
            {#                 }#}
            {#             }#}
            {#         } catch (ex) { /* ignore */#}
            {#         }#}
            {#     }, 0);#}
            {# });#}
        } catch (e) {
        }

        function openGlobalFieldEditorForToken(initial, onOk) {
            try {
                // Ensure GFE script is available; if not, we still render instructions
                var modalEl = document.getElementById('interactionModal');
                var modal = new bootstrap.Modal(modalEl);
                $('#interactionModalTitle').text('Edit Global Field Expression');
                var $body = $('#interactionModalBody');
                $body.empty();
                $body.append('<div id="gfe-inline" class="my-2"></div>');
                $body.append('<div class="d-flex justify-content-end gap-2 mt-2">\
                    <button type="button" class="btn btn-c2-secondary" data-bs-dismiss="modal">Cancel</button>\
                    <button type="button" class="btn btn-c2" id="gfe-inline-apply">Apply</button>\
                </div>');

                // Initialize editor after modal shown to ensure layout is correct
                var initGfe = function () {
                    try {
                        var fields = {}; // example fields not critical; server builds examples too
                        var previewUrl = '/api/preview_global_field';
                        var api = GlobalFieldEditor && GlobalFieldEditor.init($('#gfe-inline'), {
                            fields: fields,
                            previewUrl: previewUrl,
                            initialExpression: '[[ ' + (initial || '').trim() + ' ]]'
                        });
                        $('#gfe-inline-apply').off('click').on('click', function () {
                            try {
                                var expr = api && api.getExpression ? api.getExpression() : '';
                                // extract inside of [[ ... ]]
                                var m = expr.match(/\[\[\s*(.*?)\s*\]\]/);
                                var tokenInside = m ? m[1] : expr;
                                if (typeof onOk === 'function') onOk(tokenInside);
                                modal.hide();
                            } catch (ex) {
                                modal.hide();
                            }
                        });
                    } catch (ex) { /* ignore */
                    }
                };
                modalEl.addEventListener('shown.bs.modal', function handler() {
                    modalEl.removeEventListener('shown.bs.modal', handler);
                    initGfe();
                });
                modal.show();
            } catch (ex) { /* ignore */
            }
        }

        // Data mode toggle
        $("#data-mode-manual").on('change', function () {
            if (this.checked) {
                $("#manual-data").show();
                $("#remote-data").hide();
            }
        });
        $("#data-mode-remote").on('change', function () {
            if (this.checked) {
                $("#manual-data").hide();
                $("#remote-data").show();
            }
        });

        // Manual options add/remove
        $("#add-option-row").on('click', function () {
            $("#manual-options-table tbody").append(`<tr>
                <td><input type=\"text\" class=\"form-control option-id\" value=\"\"></td>
                <td><input type=\"text\" class=\"form-control option-value\" value=\"\"></td>
                <td><button type=\"button\" class=\"btn btn-sm btn-outline-danger remove-option\"><i class=\"bi bi-trash\"></i></button></td>
            </tr>`);
        });
        $(document).on('click', '.remove-option', function () {
            $(this).closest('tr').remove();
            schedule_update_preview(false, 'manual option removed');
        });

        // Custom columns add/remove
        $(document).on('click', '#add-column-row', function () {
            $("#custom-columns-table tbody").append(`<tr>
                <td><input type=\"text\" class=\"form-control col-key\" value=\"\"></td>
                <td><input type=\"text\" class=\"form-control col-name\" value=\"\"></td>
                <td>
                    <select class=\"form-select form-select-sm col-type\">
                        <option value=\"string\" selected>string</option>
                        <option value=\"number\">number</option>
                        <option value=\"checkbox\">checkbox</option>
                        <option value=\"select\">select</option>
                        <option value=\"select_multiple\">select_multiple</option>
                        <option value=\"date\">date</option>
                        <option value=\"time\">time</option>
                        <option value=\"datetime\">datetime</option>\n                        <option value=\"file\">file</option>
                    </select>
                </td>Add
                <td><input type=\"text\" class=\"form-control col-options\" value=\"\"></td>
                <td>
                    <div class=\"input-group input-group-sm col-field-container\">\
                        <input type=\"text\" class=\"form-control col-field browse-field\" placeholder=\"pick a .field.yaml\" value=\"\">\
                        <button type=\"button\" class=\"btn btn-outline-secondary browse-col-field\" title=\"Browse .field.yaml\" data-bs-toggle=\"modal\" data-bs-target=\"#browseFileModal\" filters=\"*.field.yaml\"><i class=\"bi bi-folder2-open\"></i></button>\
                    </div>
                </td>
                <td><button type=\"button\" class=\"btn btn-sm btn-outline-danger remove-column\"><i class=\"bi bi-trash\"></i></button></td>
            </tr>`);
            schedule_update_preview(false, 'column added');
        });
        $(document).on('click', '.remove-column', function () {
            $(this).closest('tr').remove();
            schedule_update_preview(false, 'column removed');
        });
        // React to edits in columns table to update preview/warning
        $(document).on('input change', '#custom-columns-table input, #custom-columns-table select', function () {
            schedule_update_preview(false, 'columns edited');
        });

        // Enable drag-and-drop reordering for dependencies
        function initDependencyDragAndDrop() {
            var $list = $("#dependencies-list");
            if (!$list.length) return;
            // delegate events for dynamically added items
            var dragSrcEl = null;
            var overAfter = false;
            $list.on('dragstart', 'li.dep-item', function (e) {
                dragSrcEl = this;
                this.classList.add('dragging');
                e.originalEvent.dataTransfer.effectAllowed = 'move';
                try {
                    e.originalEvent.dataTransfer.setData('text/plain', 'drag');
                } catch (ex) {
                }
            });
            $list.on('dragend', 'li.dep-item', function () {
                this.classList.remove('dragging');
                dragSrcEl = null;
            });
            $list.on('dragover', 'li.dep-item', function (e) {
                e.preventDefault(); // allow drop
                var rect = this.getBoundingClientRect();
                var midpoint = rect.top + rect.height / 2;
                overAfter = (e.originalEvent.clientY > midpoint);
                this.classList.add('drag-over');
            });
            $list.on('dragleave', 'li.dep-item', function () {
                this.classList.remove('drag-over');
            });
            $list.on('drop', 'li.dep-item', function (e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (!dragSrcEl || dragSrcEl === this) return;
                if (overAfter) {
                    this.parentNode.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(dragSrcEl, this);
                }
                update_dependencies_json();
            });
        }

        // Initialize now and also after modal closes (in case list created later)
        setTimeout(initDependencyDragAndDrop, 0);

        // Dependencies add/remove
        $("#add-dependency").on('click', function () {
            var val = $("#dependency-file-input").val().trim();
            if (!val) return;
            var exists = false;
            $("#dependencies-list .dep-text").each(function () {
                if ($(this).text() === val) {
                    exists = true;
                }
            });
            if (!exists) {
                $("#dependencies-list").append(`<li class=\"list-group-item d-flex align-items-center dep-item\" draggable=\"true\">\
                                    <span class=\"dep-handle bi bi-grip-vertical me-2\" title=\"Drag to reorder\" style=\"cursor: grab;\"></span>\
                                    <span class=\"dep-text flex-grow-1\">${val}</span>\
                                    <button type=\"button\" class=\"btn btn-sm btn-outline-danger remove-dep\"><i class=\"bi bi-x\"></i></button>\
                                </li>`);
                $("#dependency-file-input").val('');
                update_dependencies_json();
            }
        });
        $(document).on('click', '.remove-dep', function () {
            $(this).closest('li').remove();
            update_dependencies_json();
        });

        // Support adding dependency via file browser limited to .field.yaml
        $('#browseFileModal').on('hidden.bs.modal', function () {
            var path = $('#dependency-file-input').val().trim();
            if (!path) return;
            addDependencyValue(path);
        });

        function addDependencyValue(val) {
            var exists = false;
            $("#dependencies-list .dep-text").each(function () {
                if ($(this).text() === val) {
                    exists = true;
                }
            });
            if (!exists) {
                $("#dependencies-list").append(`<li class="list-group-item d-flex align-items-center dep-item" draggable="true">\
                    <span class="dep-handle bi bi-grip-vertical me-2" title="Drag to reorder" style="cursor: grab;"></span>\
                    <span class="dep-text flex-grow-1">${val}</span>\
                    <button type="button" class="btn btn-sm btn-outline-danger remove-dep"><i class="bi bi-x"></i></button>\
                </li>`);
                update_dependencies_json();
            }
        }

        function update_dependencies_json() {
            var arr = [];
            $("#dependencies-list .dep-text").each(function () {
                arr.push($(this).text());
            });
            $("#dependencies-json").val(JSON.stringify(arr));
            // Keep dependent field dropdown in sync with current dependencies
            try {
                refreshDependentFieldList();
            } catch (e) { /* ignore */
            }
            schedule_update_preview(true, 'dependencies list changed', 300);
        }

        // Remote data preview: fetch via same API used by select2 and render with bootstrap-table below the editor
        $("#btn-preview-remote").on('click', function () {
            // Build the data execute URL similar to datasource_url()
            var src = ($("#field_data_source").val() || "").trim();
            var q = (getEditorValue("field_data_query") || "").trim();
            if (!src) {
                flash("Please provide a Source to preview remote data.", "warning");
                return;
            }

            // Ensure the top preview stays as-is (do not refresh it), just compute current config for context
            var codeObj = build_data_json();
            var original_url = undefined;
            try {
                original_url = $(".embedded").eq(0).attr("original_url");
            } catch (e) {
            }

            // If src is a relative path (no leading slash and not a full URL), resolve it against the current URL,
            // offset by the first two folders in the URL path (they do not refer to the path)
            (function () {
                try {
                    var isFullUrl = /^https?:\/\//i.test(src);
                    if (!isFullUrl) {
                        // Compute base path from current location, ignoring first two segments
                        var path = window.location.pathname || "/";
                        var segments = path.split('/'); // ['', seg1, seg2, ...]
                        // Keep from index 3 onward (drop '', seg1, seg2) and drop the last segment (current filename)
                        var baseSegments = segments.slice(3);
                        if (baseSegments.length > 0) {
                            baseSegments = baseSegments.slice(0, -1);
                        }

                        function normalize(parts) {
                            var stack = [];
                            for (var i = 0; i < parts.length; i++) {
                                var p = parts[i];
                                if (!p || p === '.') continue;
                                if (p === '..') {
                                    if (stack.length) stack.pop();
                                    continue;
                                }
                                stack.push(p);
                            }
                            return stack;
                        }

                        var srcStr = (src || '').trim();
                        if (srcStr.startsWith('/')) {
                            // Already absolute within app; remove the first empty element to avoid double slash below
                            srcStr = srcStr.replace(/^\/+/, '');
                            baseSegments = [];
                        }
                        var srcParts = srcStr.split('/');
                        var combined = normalize(baseSegments.concat(srcParts));
                        src = '/' + combined.join('/');
                    }
                } catch (e) { /* ignore */
                }
            })();

            // Construct GET query string parameters
            var url = "/web/data/execute/query/" + src;
            var params = [];
            if (q) params.push("query=" + encodeURIComponent(q));
            params.push("clarama-field-format=True");
            if (params.length > 0) url += "?" + params.join("&");

            // Build POST body similar to select2 ajax: search, values, original_url
            var postBody = {
                search: null,
                values: {},
                original_url: original_url || ""
            };
            // Try to capture current field values if available
            if (typeof get_field_values === 'function') {
                try {
                    postBody.values = get_field_values({}, true, undefined) || {};
                } catch (e) {
                }
            }

            // Show loading state
            $("#remote-preview").show();
            var $thead = $("#remote-preview-table thead");
            var $tbody = $("#remote-preview-table tbody");
            $thead.html("<tr><th>Loading...</th></tr>");
            $tbody.empty();

            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(postBody),
                success: function (data) {
                    if (data && data['data'] === 'ok' && data['results']) {
                        // Update query info if provided
                        if (data['results']['info'] && data['results']['info']['query']) {
                            $('#clarama-query-result').text(data['results']['info']['query']);
                        }
                        // Render using bootstrap-table helper
                        try {
                            bTable('remote-preview-table', data['results']);
                        } catch (e) {
                            // Fallback manual render
                            var cols = data['results']['cols'] || [];
                            var rows = data['results']['rows'] || [];
                            var ths = cols.map(c => '<th>' + c + '</th>').join('');
                            $thead.html('<tr>' + ths + '</tr>');
                            var trs = '';
                            rows.forEach(function (r) {
                                var tds = '';
                                for (var i = 0; i < cols.length; i++) {
                                    tds += '<td>' + (r[i] !== undefined ? r[i] : '') + '</td>';
                                }
                                trs += '<tr>' + tds + '</tr>';
                            });
                            $tbody.html(trs);
                        }
                        // After rendering remote preview, warn if only one column is present
                        try {
                            var previewCols = (data['results'] && data['results']['cols']) || [];
                            var colCount = Array.isArray(previewCols) ? previewCols.length : 0;
                            var $warn = $('#list-columns-warning');
                            if ($warn.length) {
                                if (colCount === 1) {
                                    $warn.text('Preview Result has only one column; two columns must be supplied.').removeClass('d-none');
                                } else if (colCount > 1) {
                                    $warn.addClass('d-none');
                                }
                            }
                        } catch (ex) { /* ignore */
                        }
                    } else {
                        var err = (data && data['error']) ? data['error'] : 'Unknown error fetching data';
                        $('#clarama-query-result').text(err);
                        $thead.html('');
                        $tbody.html('<tr><td class="text-danger">' + err + '</td></tr>');
                        // Hide the warning on error
                        $('#list-columns-warning').addClass('d-none');
                    }
                },
                error: function (xhr) {
                    var msg = 'Request failed: ' + (xhr.responseText || xhr.statusText || xhr.status);
                    $('#clarama-query-result').text(msg);
                    $thead.html('');
                    $tbody.html('<tr><td class="text-danger">' + msg + '</td></tr>');
                    // Hide the warning on request failure
                    $('#list-columns-warning').addClass('d-none');
                }
            });
        });

        // Initialize dependencies json from server-rendered list, ensure hidden input matches list
        // update_dependencies_json(); schedule_update_preview does this now

        // Populate dependent field listbox from dependencies
        function refreshDependentFieldList() {
            try {
                var deps = [];
                try {
                    deps = JSON.parse($("#dependencies-json").val() || '[]') || [];
                } catch (e) {
                    deps = [];
                }
                var $sel = $("#gfe_dep_field");
                if ($sel.length === 0) return;
                var current = $sel.val();
                $sel.empty();
                if (deps.length === 0) {
                    $sel.append('<option value="" disabled selected>No dependencies</option>');
                    return;
                }
                // convert file paths like "/content/path/field_name.field.yaml" to id "field_name"
                deps.forEach(function (d) {
                    var name = (d || '').split('/').pop(); // last segment
                    // remove extension variants
                    name = name.replace(/\.field\.ya?ml$/i, '');
                    name = name.replace(/\.[^\.]+$/i, '');
                    $sel.append('<option value="' + name + '">' + name + '</option>');
                });
                if (current) {
                    $sel.val(current);
                }
            } catch (e) { /* ignore */
            }
        }

        // Refresh when dependencies change
        $(document).on('click', '#add-dependency, .remove-dep', function () {
            setTimeout(function () {
                refreshDependentFieldList();
            }, 0);
        });
        $(document).on('change', '#dependency-file-input', function () {
            setTimeout(function () {
                refreshDependentFieldList();
            }, 0);
        });
        // Initial fill
        setTimeout(refreshDependentFieldList, 50);

        // Initial render of custom pane and preview
        renderCustomPane(key);
        schedule_update_preview(true, 'initial render', 0);
    });

    function build_data_json() {
        // Returns a JS object to be encoded to YAML/JSON
        var isManual = $("#data-mode-manual").is(':checked');
        var isRemote = $("#data-mode-remote").is(':checked');
        var data = {};
        if (isManual) {
            var options = [];
            $("#manual-options-table tbody tr").each(function () {
                var id = $(this).find('input.option-id').val();
                var value = $(this).find('input.option-value').val();
                if (id !== '' || value !== '') options.push({id: id, value: value});
            });
            if (options.length > 0) data['options'] = options;
        }
        if (isRemote) {
            var src = $("#field_data_source").val();
            var q = getEditorValue("field_data_query");
            if (src && src.trim() !== '') data['source'] = src;
            if (q && q.trim() !== '') data['params'] = {query: q};
        }
        // Always include columns if any are defined and type is list (even if not in Custom mode),
        // so columns can coexist with remote/manual data for list fields.
        if (key === 'list') {
            var cols = [];
            $("#custom-columns-table tbody tr").each(function () {
                var k = $(this).find('input.col-key').val().trim();
                var n = $(this).find('input.col-name').val().trim();
                var t = ($(this).find('select.col-type').val() || 'string').trim();
                var o = $(this).find('input.col-options').val().trim();
                var f = $(this).find('input.col-field').val() ? $(this).find('input.col-field').val().trim() : '';
                if (k || n || t || o || f) {
                    var entry = {key: k || (n || ''), name: n || (k || ''), type: t || 'string'};
                    if (o) {
                        var arr = o.split(',').map(function (s) {
                            return s.trim();
                        }).filter(function (s) {
                            return s.length > 0;
                        });
                        if (arr.length > 0) entry['options'] = arr;
                    }
                    if (f) entry['field'] = f;
                    cols.push(entry);
                }
            });
            if (cols.length > 0) data['columns'] = cols;
        }
        return data;
    }

    // Debounced preview scheduler with configurable timing and dependency refresh behavior
    var _updateTimer = null;

    function parseBoolAttr(val, defaultVal) {
        if (val === undefined || val === null || val === '') return defaultVal;
        var s = String(val).toLowerCase().trim();
        if (['true', '1', 'yes', 'y', 'on'].indexOf(s) >= 0) return true;
        if (['false', '0', 'no', 'n', 'off'].indexOf(s) >= 0) return false;
        return defaultVal;
    }

    function schedule_update_preview(markDepsChanged, label, scheduleTime) {
        if (scheduleTime === undefined || scheduleTime === null) scheduleTime = 2000;

        if (scheduleTime > 0) {
            if (_updateTimer) {
                clearTimeout(_updateTimer);
            }
            _updateTimer = setTimeout(function () {
                //flash(label + ":" + scheduleTime + " / " + markDepsChanged);
                var flag = markDepsChanged;
                _updateTimer = null;
                update_preview(flag);
            }, scheduleTime);
        } else {
            //flash(label);
            update_preview(markDepsChanged);
        }

    }

    function update_preview(depsChanged) {
        // Toggle list columns warning when applicable
        try {
            var isList = (typeof key !== 'undefined' && String(key).toLowerCase() === 'list');
            var colsCount = 0;
            if (isList) {
                // Count meaningful column rows (any cell filled) from the custom columns table
                $("#custom-columns-table tbody tr").each(function () {
                    var k = $(this).find('input.col-key').val().trim();
                    var n = $(this).find('input.col-name').val().trim();
                    var t = ($(this).find('select.col-type').val() || '').trim();
                    var o = $(this).find('input.col-options').val().trim();
                    var f = $(this).find('input.col-field').val() ? $(this).find('input.col-field').val().trim() : '';
                    if (k || n || t || o || f) colsCount += 1;
                });
            }
            var $warn = $("#list-columns-warning");
            if ($warn.length) {
                if (isList && colsCount === 1) {
                    $warn.removeClass('d-none');
                } else {
                    $warn.addClass('d-none');
                }
            }
        } catch (e) { /* ignore */
        }
        var codeObj = build_data_json();
        var code = JSON.stringify(codeObj, null, 2); // JSON is valid YAML
        $("#data_text").val(code);

        // Helper to resolve a possibly-relative path against current location
        function resolvePath(p) {
            try {
                if (!p) return '';
                var isFullUrl = /^https?:\/\//i.test(p);
                if (isFullUrl) return p; // leave external URLs as-is

                var path = window.location.pathname || "/";
                var segments = path.split('/'); // ['', seg1, seg2, ...]
                // Keep from index 3 onward (drop '', seg1, seg2) and drop the last segment (current filename)
                var baseSegments = segments.slice(3);
                if (baseSegments.length > 0) {
                    baseSegments = baseSegments.slice(0, -1);
                }

                function normalize(parts) {
                    var stack = [];
                    for (var i = 0; i < parts.length; i++) {
                        var part = parts[i];
                        if (!part || part === '.') continue;
                        if (part === '..') {
                            if (stack.length) stack.pop();
                            continue;
                        }
                        stack.push(part);
                    }
                    return stack;
                }

                var srcStr = (p || '').trim();
                if (srcStr.startsWith('/')) {
                    // Already absolute within app; remove the first empty element to avoid double slash below
                    srcStr = srcStr.replace(/^\/+/, '');
                    baseSegments = [];
                }
                var srcParts = srcStr.split('/');
                var combined = normalize(baseSegments.concat(srcParts));
                return '/' + combined.join('/');
            } catch (e) {
                return p;
            }
        }

        // Build dependency preview elements only if dependencies changed during debounce window
        var depDivs = [];
        var $depsContainer = $("#dependencies-preview");
        if (depsChanged === true) {
            var deps = [];
            try {
                deps = JSON.parse($("#dependencies-json").val() || '[]') || [];
            } catch (e) {
                deps = [];
            }
            $depsContainer.empty();
            if (deps.length > 0) {
                // Add a small title
                $depsContainer.append('<div class="text-muted small mb-1">Dependencies</div>');
                for (var i = 0; i < deps.length; i++) {
                    var depPath = resolvePath(deps[i]);
                    var depUrl = '/render/embed' + depPath;
                    var depId = 'dep_preview_' + i;
                    var depHtml = '<div id="' + depId + '" class="clarama-post-embedded border rounded bg-light p-2 mb-1" url="' + depUrl + '" source_url="' + depPath + '"></div><i class="fs-3 bi bi-arrow-down" style="margin-left: 70px;"></i>';
                    $depsContainer.append(depHtml);
                    depDivs.push('#' + depId);
                }
            }
        }

        // Now prepare main preview URL, but defer loading until dependencies are loaded
        var mainUrl = "{{ embedded_url(filename=file_url) }}"
            + "?type=" + encodeURIComponent(key)
            + "&name=" + encodeURIComponent($("#name").val())
            + "&description=" + encodeURIComponent($("#description").val())
            + "&placeholder=" + encodeURIComponent($("#placeholder").val())
            + "&default=" + encodeURIComponent($("#default").val())
            + "&maximum=" + encodeURIComponent($("#maximum").val())
            + "&minimum=" + encodeURIComponent($("#minimum").val())
            + "&readonly=" + encodeURIComponent($("#readonly").prop('checked'))
            + "&required=" + encodeURIComponent($("#required").prop('checked'))
            + "&sticky=" + encodeURIComponent($("#sticky").prop('checked'))
            + "&step=" + encodeURIComponent($("#step").val())
            + "&spacing=" + encodeURIComponent($("#spacing").val())
            + "&filters=" + encodeURIComponent($("#filters").val() || '')
            + "&pattern=" + encodeURIComponent($("#pattern").val() || '')
            + "&autocomplete=" + encodeURIComponent($("#autocomplete").val() || '')
            + "&suggestions=" + encodeURIComponent(($('#suggestions').val() || '').split(/\r?\n/).filter(s => s.trim().length > 0).join('|'))
            + "&data_text=" + encodeURIComponent(code);

        // For select-type fields, include column mapping indices in preview URL so the embedded can honor them
        try {
            var _t = String(key || '').toLowerCase();
            if (_t === 'select' || _t === 'select_multiple') {
                var _idc = $('#id_column').val() || '';
                var _valc = $('#value_column').val() || '';
                var _selc = $('#select_column').val() || '';
                var _disabc = $('#disable_column').val() || '';
                mainUrl += "&id_column=" + encodeURIComponent(_idc)
                    + "&value_column=" + encodeURIComponent(_valc)
                    + "&select_column=" + encodeURIComponent(_selc)
                    + "&disable_column=" + encodeURIComponent(_disabc);
            }
        } catch (e) { /* ignore */
        }

        function loadMainPreview() {
            $("#preview").attr("url", mainUrl);
            $("#preview").attr("clarama_loaded", false);
            $('#preview').load();
        }

        if (depDivs.length === 0) {
            // No dependencies, just load main preview
            loadMainPreview();
        } else {
            // Load dependencies sequentially, then main preview
            var idx = 0;

            function loadNext() {
                if (idx >= depDivs.length) {
                    loadMainPreview();
                    return;
                }
                var sel = depDivs[idx++];
                try {
                    $(sel).attr('clarama_loaded', false);
                    $(sel).attr('autorun', true);
                    $(sel).load_post(function () {
                        loadNext();
                    }, undefined, {});
                } catch (e) {
                    loadNext();
                }
            }

            loadNext();
        }
    }

    function save_field() {
        var codeObj = build_data_json();
        var code = JSON.stringify(codeObj, null, 2);

        var deps_json = $("#dependencies-json").val();
        var deps = [];
        try {
            deps = JSON.parse(deps_json || '[]');
        } catch (e) {
            deps = [];
        }

        var field_data = {
            "type": key,
            "name": $("#name").val(),
            "description": $("#description").val(),
            "placeholder": $("#placeholder").val(),
            "default": $("#default").val(),
            "maximum": $("#maximum").val(),
            "minimum": $("#minimum").val(),
            "step": $("#step").val(),
            "spacing": $("#spacing").val(),
            "readonly": $("#readonly").prop('checked'),
            "required": $("#required").prop('checked'),
            "sticky": $("#sticky").prop('checked'),
            "filters": $("#filters").val(),
            "pattern": $("#pattern").val(),
            "autocomplete": $("#autocomplete").val(),
            "suggestions": (function () {
                try {
                    return ($('#suggestions').val() || '').split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
                } catch (e) {
                    return [];
                }
            })(),
            "dependencies": deps,
            "data_text": code
        };

        // Include per-type custom options into field_data
        try {
            var t = String(key || '').toLowerCase();
            if (t === 'number') {
                field_data['unit'] = $('#num_unit').val() || '';
                field_data['decimals'] = $('#num_decimals').val() || '';
                field_data['thousands'] = $('#num_thousands').val() || '';
            } else if (t === 'datetime' || t === 'date' || t === 'time') {
                field_data['format'] = $('#dt_format').val() || '';
                field_data['min'] = $('#dt_min').val() || '';
                field_data['max'] = $('#dt_max').val() || '';
            } else if (t === 'tagcloud') {
                field_data['mode'] = ($('#tc_mode').val() || 'move');
                field_data['editable'] = !!($('#tc_editable').prop('checked'));
            } else if (t === 'daterange') {
                field_data['time_enabled'] = !!($('#dr_time_enabled').prop('checked'));
                field_data['milliseconds'] = !!($('#dr_milliseconds').prop('checked'));
                // Store ranges as raw text; server persists as-is (string) to allow flexible parsing later
                field_data['ranges'] = ($('#dr_ranges').val() || '').trim();
            } else if (t === 'select' || t === 'select_multiple') {
                // Save custom column mapping options for select/select_multiple
                field_data['id_column'] = $('#id_column').val() || '';
                field_data['value_column'] = $('#value_column').val() || '';
                field_data['select_column'] = $('#select_column').val() || '';
                field_data['disable_column'] = $('#disable_column').val() || '';
            } else {
                field_data['maxlength'] = $('#str_maxlength').val() || '';
                field_data['transform'] = $('#str_transform').val() || '';
            }
        } catch (e) { /* ignore */
        }

        console.log("Field save data", field_data);

        var url = "/content/save/" + $("#save").attr("url");

        $.ajax({
            type: 'POST',
            url: url,
            datatype: "html",
            contentType: 'application/json',
            data: JSON.stringify(field_data),
            success: function (data) {
                if (data['data'] == 'ok') {
                    flash("Saved!", "success");
                } else {
                    flash("Couldn't save content: " + data['error'], "danger");
                }
            },
            error: function (data) {
                flash("Couldn't save content, access denied", "danger");
            }
        });
    }
</script>
<script src="{{ static( filename='js/global_field_editor.js') }}" type="text/javascript"></script>

<!-- Query Help Modal -->
<div class="modal fade" id="queryHelpModal" tabindex="-1" aria-labelledby="queryHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="queryHelpModalLabel">Query Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">You can enter SQL (or a path/YAML depending on the Source type).</p>
                <h6>SQL basics</h6>
                <ul>
                    <li>SELECT col1, col2 FROM table WHERE col1 = 'value'</li>
                    <li>Use LIKE for wildcard search: col1 LIKE '%text%'</li>
                    <li>Use IN for lists: col1 IN ('a','b','c')</li>
                    <li>The first column of the result is used as the ID, the second as the display value.</li>
                </ul>
                <h6 class="mt-3">Global fields preprocessing</h6>
                <p>Before SQL (or any other query type) is executed, Clarama preprocesses the text using the "Global
                    Fields" function. This lets
                    you insert variables and build common SQL fragments.
                    These placeholders use double square brackets [[...]].
                    They are used to reference both the name and current value of other fields that may be chosen by the
                    user.
                </p>
                <p>
                    Field names here are based off the <i>filename</i> of the field, not the "name" property.
                    For example, if you have a field named "my_field.field.yaml", you can use [[my_field]] to reference
                    the
                    value of the field.</p>
                <p>
                    Spaces, symbols and other characters are replaced with _. Field names are <i>always</i> lower case.
                </p>
                <ul>
                    <li>[[field_name]] — simple substitution of a scalar value.</li>
                    <li>[[field_name:list]] — join a list with commas (a,b,c).</li>
                    <li>[[field_name:sql]] — join a list as single-quoted SQL values ('a','b','c').</li>
                    <li>[[field_name:in]] — expand to: field_name IN ('a','b',...).</li>
                    <li>[[field_name:where]] — expand to: WHERE field_name IN ('a','b',...).</li>
                    <li>[[field_name:search]] — expand to: field_name LIKE '%search%' (use mapping below to choose
                        column).
                    </li>
                    <li>Comparators: [[field_name:==]], [[field_name:=]], [[field_name:!=]] (or <>), [[field_name:>]],
                        [[field_name:<]], [[field_name:>=]], [[field_name:<=]] — expand to standard SQL comparisons
                        using the field's value.
                    </li>
                    <li>Mapping: [[from=>to:layout]] — use field_name <em>from</em> but target DB column
                        <em>to</em>. This is if the field_name differs from the database name.
                    </li>
                    <li>Extensions: Some layouts accept an extension after a third colon, e.g. [[field_name:in:AND]] or
                        [[field_name:search:AND]]. For LIKE, [[field_name:like]] generates multiple ORed LIKE parts if
                        the field_name is a list.
                    </li>
                </ul>
                <p class="text-muted small">Missing field_name remove the placeholder, ie.. the user did not select
                    anything, or the required field was not added.</p>
                <h6 class="mt-3">Examples</h6>
                <pre class="small bg-light p-2 border">SELECT id, name FROM users WHERE [[status=>status:in:AND]] [[name=>name:search]]</pre>
                <p class="small text-muted">If status=[active,disabled] and search name='ann', the above becomes e.g.
                    "status IN ('active','disabled') AND name LIKE '%ann%'".</p>

                <p class="small text-muted">If status is not available/found and search name='ann', the above becomes
                    e.g.
                    "name LIKE '%ann%'".</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-c2-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% include theme("explorer/files/browse_file_modal.html") %}
{% include theme("explorer/files/file_modal_shared_logic.html") %}
{% include theme("web/file_footer.html") %}
