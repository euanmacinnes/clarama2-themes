<template id="task_step_exception" target_class="cell-results">
    <div class="row alert alert-danger">
        <b>Exception</b><br/><br/>
        <div class="input-group mb-3">
            <div class="form-floating">
                <span class="clarama-capitalize clarama-error" data-bs-toggle="collapse"
                      data-bs-target="#collapse{instance_content}">{exception_content}</span>
            </div>
            <button class="btn btn-primary mt-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse{instance_content}"
                    aria-expanded="false" aria-controls="collapse{instance_content}">
                ...
            </button>
        </div>
        <hr/>
        <div class="collapse" id="collapse{instance_content}">
            <div class="card card-body">
                <pre class="pre_response"><code class="code_response">{last_traceback_content}</code></pre>
            </div>
        </div>
    </div>
</template>

<template id="task_step_error" target_class="cell-results">
    <div class="row alert alert-danger">
        <div>
            <table>
                <tr>
                    <td>
                        <b class="clarama-error">{message_content}</b>
                    </td>
                    <td>&nbsp;&nbsp;&nbsp;</td>
                    <td>
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse{instance_content}"
                                aria-expanded="false" aria-controls="collapse{instance_content}">
                            ...
                        </button>
                    </td>
            </table>
        </div>
        <div class="collapse" id="collapse{instance_content}">
            <div class="card card-body">
                <pre class="pre_response"><code class="code_response">{details_content}</code></pre>
            </div>
        </div>
    </div>
</template>

<template id="task_step_warn" target_class="cell-results">
    <div class="row alert alert-warning">
        <div><b>{message_content}</b>
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse{instance_content}"
                    aria-expanded="false" aria-controls="collapse{instance_content}">
                ...
            </button>
        </div>
        <div class="collapse" id="collapse{instance_content}">
            <div class="card card-body">
                <pre class="pre_response"><code class="code_response">{details_content}</code></pre>
            </div>
        </div>
    </div>
</template>

<template id="task_step_info" target_class="cell-results">
    <div class="row alert alert-primary">
        <div><b>{message_content}</b>
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse{instance_content}"
                    aria-expanded="false" aria-controls="collapse{instance_content}">
                ...
            </button>
        </div>
        <div class="collapse" id="collapse{instance_content}">
            <div class="card card-body">
                <pre class="pre_response"><code class="code_response">{details_content}</code></pre>
            </div>
        </div>
    </div>
</template>

<template id="task_step_completed" target_class="cell-timing">
    <div class="container" style="opacity: 0.3">
        <div class="row">
            <div class="col">{duration_content}</div>
        </div>
        <br/>
    </div>
</template>

<template id="progress_bar_item" target_class="cell-results">
    <div class="card shadow-sm mb-2" id="pb_{id_content}"
         style="min-width:260px; background-color:#1f1f1f; color:#fff; border:1px solid #2a2a2a;">
        <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="fw-semibold">{title_content}</div>
                <div class="small text-white-50" id="pb_{id_content}_percent">{percent_content}%</div>
            </div>
            <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-success" id="pb_{id_content}_bar" style="width:{percent_content}%"></div>
            </div>
            <div class="d-flex justify-content-between small text-white-50 mt-1">
                <div id="pb_{id_content}_elapsed">t: {elapsed_content}s</div>
                <div id="pb_{id_content}_avg">avg: {avg_content}s</div>
                <div id="pb_{id_content}_eta">eta: {eta_content}s</div>
            </div>
        </div>
    </div>
</template>

<template id="task_step_result" target_class="cell-results">
    <pre class="print_response"><code class="code_response">{output_content}</code></pre>
</template>

<template id="task_step_html" target_class="cell-results">
    <div>{output_content}</div>
</template>

<template id="task_step_result_web_server" target_class="cell-results">
    <div>{webpage_content}</div>
</template>

<template id="task_step_result_web_client" target_class="cell-results">
    <div url="{url_content}" class="clarama-embedded">Loading {url_content}...</div>
</template>

<template id="task_step_result_test" target_class="cell-results">
    <div class="test-result-container">
        <div class="test-header">
            <h4>Test Results</h4>
            <span class="badge bg-{status_class_content}">{status_content}</span>
        </div>
        <div class="test-details">
            <div class="test-summary">
                <p><strong>Browser:</strong> {browser_content}</p>
                <p><strong>Duration:</strong> {duration_content}</p>
                <p><strong>Total Steps:</strong> {total_steps_content}</p>
                <p><strong>Passed Steps:</strong> {passed_steps_content}</p>
                <p><strong>Failed Steps:</strong> {failed_steps_content}</p>
            </div>
            <div class="test-output">
                <h5>Test Output</h5>
                <pre class="test-output-content">{output_content}</pre>
            </div>
            <div class="test-screenshots" style="display: {screenshots_display_content}">
                <h5>Screenshots</h5>
                <div class="screenshot-gallery">
                    {screenshots_content}
                </div>
            </div>
        </div>
    </div>
</template>

<template id="task_step_result_bootstraptable" target_class="cell-results">
    <div class="tight" style="overflow: auto; height: 100%">
        <nav class="navbar navbar-expand-lg table-{style_content}-header table-header"
             style="display: {display_content}">
            <ul class="navbar-nav table-header-nav-bar">
                <li class="nav-item table-header-nav-item">
                    {title_content}
                </li>
                <li class="nav-item table-header-nav-item">
                    <div class="nav-link buttons-toolbar-{table_id_content} table-header-nav-toolbar">
                    </div>
                </li>
            </ul>
        </nav>
        <table id="{table_id_content}"
               data-show-columns="false"
               data-filter-control="{filter_content}"
               data-click-to-select="true"
               data-checkbox="{checkbox_content}"
               data-id-field="{id_content}"
               data-show-footer="{footer_content}"
               data-show-columns-toggle-all="true"
               data-show-pagination-switch="false"
               data-show-export="{export_content}"
               data-pagination="{pagination_content}"
               data-multiple-select-row="{multiselect_row_content}"
               data-buttons-toolbar=".buttons-toolbar-{table_id_content}"
               data-page-size="{pagesize_content}"
               data-sortable="{sortable_content}"
               data-search="{search_content}"
               data-export-options="{exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf']}"
               class="table table-hover table-{style_content}"
        ></table>
    </div>
</template>


<template id="task_step_result_bootstraptable_slate" target_class="cell-results">
    <div class="tight" style="overflow: auto; height: 100%">
        <nav class="navbar navbar-expand-lg table-{style_content}-header table-header">
            <ul class="navbar-nav table-header-nav-bar">
                <li class="nav-item table-header-nav-text">
                    {title_content}
                </li>
                <li class="nav-item table-header-nav-item">
                    <div class="nav-link buttons-toolbar-{table_id_content} table-header-nav-toolbar">
                    </div>
                </li>
            </ul>
        </nav>
        <table id="{table_id_content}"
               data-show-columns="false"
               data-filter-control="{filter_content}"
               data-click-to-select="true"
               data-checkbox="{checkbox_content}"
               data-id-field="{id_content}"
               data-show-footer="{footer_content}"
               data-show-columns-toggle-all="true"
               data-show-pagination-switch="false"
               data-show-export="{export_content}"
               data-pagination="{pagination_content}"
               data-multiple-select-row="{multiselect_row_content}"
               data-buttons-toolbar=".buttons-toolbar-{table_id_content}"
               data-card-view="false"
               data-custom-view-default-view="true"
               data-show-custom-view="true"
               data-custom-view="customViewFormatter"
               data-page-size="{pagesize_content}"
               data-sortable="{sortable_content}"
               data-search="{search_content}"
               data-export-options="{exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf']}"
               class="table table-hover table-{style_content}"
        ></table>
    </div>

    <script>
        window.customViewFormatter = data => {
            const template = $('#slateRowTemplate').html()
            let view = ''

            $.each(data, function (i, row) {
                let encoded_row = btoa(JSON.stringify({record: row}))
                let grid_id = encodeURIComponent('{tableslate_content}_' + i);
                view += template.replaceAll('%ROW%', encoded_row)
                    .replaceAll('%SLATE%', '{tableslate_content}')
                    .replaceAll('%GRID_ID%', grid_id)
                    .replaceAll('%ROW_NUMBER%', i + 1)
            })

            return `${view}`
        }
    </script>
</template>


<template id="slateRowTemplate">
    <div class="d-flex flex-row mx-0 p-3 clarama-slate-record" encoded_json="%ROW%">
        <div class="me-3">
            %ROW_NUMBER%.
        </div>
        <div class="w-100 clarama-post-embedded clarama-record-header"
             url='/render/embed/%SLATE%?slate_id=%ROW_NUMBER%'>
        </div>
    </div>
</template>

<template id="task_step_result_table" target_class="cell-results">
    <table id="{table_id_content}"
           data-toggle="table"
           data-show-columns="true"
           data-filter-control="true"
           data-click-to-select="true"
           data-id-field="id"
           data-show-footer="true"
           data-show-export="true"
           data-pagination="true"
           data-page-size="15"
           data-search="true"
           data-export-options="{exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf']}"
           class="table table-striped table-hover">
        <thead>
        <tr>
            <!--{array:start}-->
            <th>
                <div>{array:value}</div>
            </th>
            <!--{array:end}-->
        </tr>
        </thead>
        <tbody id="{table_id_content}_tbody" class="{table_id_content}_tbody">
        </tbody>
    </table>
</template>

<template id="task_step_result_table_row" target_class="{table_id_content}_tbody">
    <tr>
        <!--{array:start}-->
        <td>
            <div>{array:value}</div>
        </td>
        <!--{array:end}-->
    </tr>
</template>

<template>
    <li class="nav-item">
        <input id="{chart_id_content}_title" type="text" class="form-control" placeholder="Title">
    </li>
    <li class="nav-item">
        <input id="{chart_id_content}_subtitle" type="text" class="form-control" placeholder="Subtitle">
    </li>
    <li class="nav-item">
        <select id="{chart_id_content}_legend" class="form-control">
            <option>No Legend</option>
            <option>Show Legend (Right)</option>
            <option>Show Legend (Bottom)</option>
            <option>Show Legend (Left)</option>
            <option>Show Legend (Top)</option>
        </select>
    </li>
    <li class="nav-item">
        <select class="col form-control">
            <option>Pie</option>
            <option>Donut</option>
            <option>Bar</option>
            <option>Line</option>
            <option>Radar</option>
            <option>Scatter</option>
        </select>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_x" class="col form-label nowrap">X Axis</label>
                <select id="{chart_id_content}_x" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_y" class="col form-label nowrap">Y Axis</label>
                <select id="{chart_id_content}_y" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_label" class="col form-label nowrap">Labels</label>
                <select id="{chart_id_content}_label" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_series" class="col form-label nowrap">Series</label>
                <select id="{chart_id_content}_series" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_lunits" class="col form-label nowrap">Left Axis Units</label>
                <select id="{chart_id_content}_lunits" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
    <li class="nav-item">
        <div class="container">
            <div class="row">
                <label for="{chart_id_content}_runits" class="col form-label nowrap">Right Axis
                    Units</label>
                <select id="{chart_id_content}_runits" class="col form-control">
                    <option></option>
                </select>
            </div>
        </div>
    </li>
</template>

<template id="task_step_result_chart" target_class="cell-results">
    <div class="container-fluid position-relative tight" style="height: 100%">
        <div id="{chart_id_content}-holder" style="min-width: 100px; width:100%; height:100%; position: relative; "
             class="chart-canvas-holder">
            <canvas id="c_{chart_id_content}" class="no-drag" width="100%"></canvas>
        </div>
    </div>
    <script>
        function resetZoom(chart_element) {
            console.log("Resetting Zoom");
            $("#" + chart_element).attr("chart").resetZoom();
        }

        var colorNames = Object.keys(window.chartColors);

        $(window).resize(function () {
            $('#c_{chart_id_content}').height($('#c_{chart_id_content}').width() / 1.7);
        });

        $(document).ready(() => {
            $('#c_{chart_id_content}').height($('#c_{chart_id_content}').width() / 1.7);
        });
    </script>

</template>

<template id="task_step_result_chart3d" target_class="cell-results">
    <div class="container-fluid position-relative tight" style="height: 100%">
        <div id="{chart_id_content}-holder" style="width:100%; height:750px; display:block;"
             class="chart3d-canvas-holder">
            <canvas id="c_{chart_id_content}" class="no-drag" width="100%"></canvas>
        </div>
    </div>
</template>

<template id="grid_new_content" target_suffix="">
    <div class="container-fluid row" style="height: 100%">
        <div id="{target}" class="col clarama-embedded slate-panel-target" style="height: 100%"
             url="/content/embedded/{ url }">
        </div>
        <div class="dropdown col col-sm-1 align-middle">
            <i class="bi bi-three-dots-vertical element_editor" data-bs-toggle="dropdown" aria-expanded="false"></i>
            <ul class="dropdown-menu embedded-dropdown-menu">
                <li><a class="dropdown-item" href="/content/edit/{ url }" target="_blank">Edit</a></li>
                <li><a class="dropdown-item" href="#" onclick="delete_element('{target}');">Delete</a></li>
            </ul>
        </div>
    </div>
</template>


<!-- Streaming Bootstrap Table Template: initializes bTableStream and can trigger a backend fetch to start the stream -->
<template id="task_step_result_bootstraptable_stream" target_class="cell-results">
    <div class="tight" style="overflow: auto; height: 100%">
        <nav class="navbar navbar-expand-lg table-{style_content}-header table-header"
             style="display: {display_content}">
            <ul class="navbar-nav table-header-nav-bar">
                <li class="nav-item table-header-nav-item">
                    {title_content}
                </li>
                <li class="nav-item table-header-nav-item">
                    <div class="nav-link buttons-toolbar-{table_id_content} table-header-nav-toolbar"></div>
                </li>
            </ul>
        </nav>
        <table id="{table_id_content}"
               data-show-columns="false"
               data-filter-control="{filter_content}"
               data-click-to-select="true"
               data-checkbox="{checkbox_content}"
               data-id-field="{id_content}"
               data-show-footer="{footer_content}"
               data-show-columns-toggle-all="true"
               data-show-pagination-switch="false"
               data-show-export="{export_content}"
               data-pagination="{pagination_content}"
               data-multiple-select-row="{multiselect_row_content}"
               data-buttons-toolbar=".buttons-toolbar-{table_id_content}"
               data-page-size="{pagesize_content}"
               data-sortable="{sortable_content}"
               data-search="{search_content}"
               data-export-options="{exportTypes: ['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf']}"
               class="table table-hover table-{style_content}"></table>
    </div>

    <script>
        (function () {
            try {
                const tableId = '{table_id_content}';
                const topic = '{topic_content}';
                const fetchUrl = '{url_content}';
                const fetchMethod = ('{method_content}' && '{method_content}' !== 'None') ? '{method_content}' : 'POST';
                const fetchBodyRaw = '{body_content}';
                const fetchBody = (fetchBodyRaw && fetchBodyRaw !== 'None') ? fetchBodyRaw : undefined;

                // If a URL is provided, call it to trigger the backend to start publishing to the topic.
                if (fetchUrl && fetchUrl !== 'None') {
                    const headers = {'Content-Type': 'application/json'};
                    try {
                        headers['Authorization'] = window.claramaAuthToken ? ('Bearer ' + window.claramaAuthToken) : headers['Authorization'];
                    } catch (e) {
                    }
                    fetch(fetchUrl, {method: fetchMethod, headers: headers, body: fetchBody})
                        .then(function (resp) { /* no-op */
                        })
                        .catch(function (err) {
                            console.error('Stream trigger fetch failed', err);
                        });
                }

                // Initialize streaming table subscription
                if (window.bTableStream) {
                    window.bTableStream(tableId, {topic: topic});
                } else {
                    console.error('bTableStream is not available on window');
                }
            } catch (e) {
                console.error('bTableStream template init error', e);
            }
        })();

        window.customViewFormatter = data => {
            const template = $('#slateRowTemplate').html()
            let view = ''

            $.each(data, function (i, row) {
                let encoded_row = btoa(JSON.stringify({record: row}))
                let grid_id = encodeURIComponent('{tableslate_content}_' + i);
                view += template.replaceAll('%ROW%', encoded_row)
                    .replaceAll('%SLATE%', '{tableslate_content}')
                    .replaceAll('%GRID_ID%', grid_id)
                    .replaceAll('%ROW_NUMBER%', i + 1)
            })

            return `${view}`
        }
    </script>
</template>
