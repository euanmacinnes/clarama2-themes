<div class="clarama-cell-content" celltype="server" dataid="{{ loop_index }}">
    <div class="bg-c2-light rounded-top text-light px-2" style="padding-top:.25rem!important;">
        <div class="d-flex align-items-center gap-2 py-1">
            <div class="text-white-50 small">Client Step</div>
        </div>
    </div>
    <div class="accordion-collapse show bg-cell-config">
        <div class="accordion-body" style="padding:8px;">
            <div class="container-fluid">
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-2"><label class="form-label mb-0">Client Type</label></div>
                    <div class="col-md-4">
                        <select class="form-control server-type">
                            <option value="opcua-client" selected>OPC-UA Client</option>
                            <option value="opcua">OPC-UA Server</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end"><label class="form-label mb-0">Instance</label></div>
                    <div class="col-md-4"><input type="text" class="form-control server-instance"
                                                 placeholder="e.g. default" value="{{ instance or 'default' }}"></div>
                </div>
                <div class="row g-2 align-items-start mb-2">
                    <div class="col-md-2 d-flex align-items-center justify-content-between">
                        <label class="form-label mb-0">YAML Config</label>
                        <button type="button" class="btn btn-sm btn-outline-info ms-2 server-help-btn" title="Show OPC-UA Client YAML example"
                                data-template="help/opcua_client_config">
                            <i class="bi bi-question-circle"></i>
                        </button>
                    </div>
                    <div class="col-md-10">
                        <div id="content_query_{{ loop_index }}_server_config" class="source-editor form-control clarama-field-editor server-config" editor="yaml"
                             style="min-height:140px">{{ content or '' }}</div>
                        <div class="text-white-50 small mt-1">Provide client options (e.g. endpoint, nodes:[]).
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-2"><label class="form-label mb-0">Expose via K8s</label></div>
                    <div class="col-md-1"><input class="form-check-input server-k8s"
                                                 type="checkbox" {{ 'checked' if k8s else '' }}></div>
                    <div class="col-md-1 text-end"><label class="form-label mb-0">Service</label></div>
                    <div class="col-md-3"><input type="text" class="form-control server-k8s-svc"
                                                 placeholder="service name" value="{{ k8s_options.service_name if k8s_options and k8s_options.service_name else '' }}">
                    </div>
                    <div class="col-md-1 text-end"><label class="form-label mb-0">Port</label></div>
                    <div class="col-md-2"><input type="number" class="form-control server-k8s-port" placeholder="4840"
                                                 value="{{ k8s_options.port if k8s_options and k8s_options.port else 4840 }}"></div>
                </div>
                <div class="row g-2 align-items-center mb-2">
                    <div class="col-md-2 text-end"><label class="form-label mb-0">Host</label></div>
                    <div class="col-md-4"><input type="text" class="form-control server-k8s-host"
                                                 placeholder="example.local" value="{{ k8s_options.host if k8s_options and k8s_options.host else '' }}"></div>
                    <div class="col-md-2 text-end"><label class="form-label mb-0">Path</label></div>
                    <div class="col-md-4"><input type="text" class="form-control server-k8s-path" placeholder="/"
                                                 value="{{ k8s_options.path if k8s_options and k8s_options.path else '/' }}"></div>
                </div>
                <div class="row g-2 align-items-center">
                    <div class="col-md-12 text-white-50 small">At runtime, the kernel will start the selected client and
                        attempt to register a Service (and Ingress if Host is set) when requested.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(() => {
        $('.source-editor').editor();
        function ensureHelpModal(){
            let $m = $('#server-help-modal');
            if($m.length === 0){
                const html = [
                    '<div class="modal fade" id="server-help-modal" tabindex="-1" aria-hidden="true">',
                    '  <div class="modal-dialog modal-lg modal-dialog-scrollable">',
                    '    <div class="modal-content">',
                    '      <div class="modal-header">',
                    '        <h5 class="modal-title">OPC-UA Client YAML Example</h5>',
                    '        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>',
                    '      </div>',
                    '      <div class="modal-body"><div class="text-muted">Loading...</div></div>',
                    '      <div class="modal-footer">',
                    '        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>',
                    '      </div>',
                    '    </div>',
                    '  </div>',
                    '</div>'
                ].join('');
                $('body').append(html);
                $m = $('#server-help-modal');
            }
            return $m;
        }
        $('.server-help-btn').on('click', function(){
            const tmpl = $(this).data('template') || 'help/opcua_client_config';
            const $m = ensureHelpModal();
            $m.find('.modal-body').html('<div class="text-muted">Loading...</div>');
            $.ajax({
                url: '/template/render/' + tmpl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({})
            }).done(function(html){
                $m.find('.modal-body').html(html);
                try{ Prism.highlightAll(); }catch(e){}
            }).fail(function(xhr){
                const msg = (xhr.responseJSON && xhr.responseJSON.error) || xhr.responseText || 'Failed to load template';
                $m.find('.modal-body').html('<div class="alert alert-danger">'+ $('<div>').text(msg).html() +'</div>');
            }).always(function(){
                try {
                    const modal = new bootstrap.Modal(document.getElementById('server-help-modal'));
                    modal.show();
                } catch(e) {
                    $('#server-help-modal').modal('show');
                }
            });
        });
    });
</script>
