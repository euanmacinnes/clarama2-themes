{% if not block %}
    {% set block = {'actions': [], 'expects': []} %}
{% endif %}
<div class="clarama-cell-content clarama-cell-border" celltype="test" dataid="{{ loop_index }}">
    <div class="card-body">
        <h5>Actions</h5>
        <div class="actions-container">
            {% for action in block.actions %}
                <div class="card mb-3 action-item">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <select class="form-control action-type">
                            <option value="goto" {% if action.type == 'goto' %}selected{% endif %}>goto</option>
                            <option value="get_by_role" {% if action.type == 'get_by_role' %}selected{% endif %}>
                                get_by_role
                            </option>
                            <option value="page_locator" {% if action.type == 'page_locator' %}selected{% endif %}>
                                page_locator
                            </option>
                        </select>
                        <button type="button" class="btn btn-danger remove-action"><i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic fields based on action type -->
                        <div class="goto-fields" {% if action.type != 'goto' %}style="display: none;"{% endif %}>
                            <div class="form-group">
                                <label>URL</label>
                                <input type="text" class="form-control goto-url"
                                       value="{{ action.url|default('') }}">
                            </div>
                        </div>

                        <div class="get_by_role-fields"
                             {% if action.type != 'get_by_role' %}style="display: none;"{% endif %}>
                            <div class="form-group mb-3">
                                <label>Role</label>
                                <input type="text" class="form-control get_by_role-role"
                                       value="{{ action.role|default('') }}">
                            </div>
                            <div class="form-group mb-3">
                                <label>Name</label>
                                <input type="text" class="form-control get_by_role-name"
                                       value="{{ action.name|default('') }}">
                            </div>

                            <h6>Role Actions</h6>
                            <div class="role-actions-container">
                                {% if action.actions %}
                                    {% for role_action in action.actions %}
                                        <div class="card mb-2 role-action-item">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <select class="form-control role-action-type">
                                                        <option value="click"
                                                                {% if role_action.type == 'click' %}selected{% endif %}>
                                                            click
                                                        </option>
                                                        <option value="fill"
                                                                {% if role_action.type == 'fill' %}selected{% endif %}>
                                                            fill
                                                        </option>
                                                        <option value="press"
                                                                {% if role_action.type == 'press' %}selected{% endif %}>
                                                            press
                                                        </option>
                                                    </select>
                                                    <button type="button" class="btn btn-danger remove-role-action">
                                                        <i class="bi bi-trash"></i></button>
                                                </div>

                                                <div class="fill-fields"
                                                     {% if role_action.type != 'fill' %}style="display: none;"{% endif %}>
                                                    <div class="form-group">
                                                        <label>Value</label>
                                                        <input type="text" class="form-control fill-value"
                                                               value="{{ role_action.value|default('') }}">
                                                    </div>
                                                </div>

                                                <div class="press-fields"
                                                     {% if role_action.type != 'press' %}style="display: none;"{% endif %}>
                                                    <div class="form-group">
                                                        <label>Key</label>
                                                        <input type="text" class="form-control press-key"
                                                               value="{{ role_action.key|default('') }}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <button type="button" class="btn btn-sm btn-c2 add-role-action">
                                <i class="bi bi-plus-circle"></i> Add Role Action
                            </button>
                        </div>

                        <div class="page_locator-fields"
                             {% if action.type != 'page_locator' %}style="display: none;"{% endif %}>
                            <div class="form-group">
                                <label>Selector</label>
                                <input type="text" class="form-control page_locator-selector"
                                       value="{{ action.selector|default('') }}">
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-c2 add-action">
            <i class="bi bi-plus-circle"></i> Add Action
        </button>

        <h5 class="mt-4">Expectations</h5>
        <div class="expects-container">
            {% if block.expects %}
                {% for expect in block.expects %}
                    <div class="row mb-3 expect-item">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Element Selector</label>
                                <input type="text" class="form-control expect-element" value="{{ expect.element }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Condition</label>
                                <select class="form-control expect-condition">
                                    <option value="visible"
                                            {% if expect.condition == 'visible' %}selected{% endif %}>Is Visible
                                    </option>
                                    <option value="contains"
                                            {% if expect.condition == 'contains' %}selected{% endif %}>Contains Text
                                    </option>
                                    <option value="has_value"
                                            {% if expect.condition == 'has_value' %}selected{% endif %}>Has Value
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Value</label>
                                <input type="text" class="form-control expect-value"
                                       value="{{ expect.value|default('') }}"
                                       {% if expect.condition == 'visible' %}disabled{% endif %}>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Timeout (ms)</label>
                                <input type="number" class="form-control expect-timeout"
                                       value="{{ expect.timeout|default(5000) }}">
                            </div>
                        </div>
                        <div class="col-auto d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-expect mb-2"><i
                                    class="bi bi-trash"></i></button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" class="btn btn-c2 add-expect">
            <i class="bi bi-plus-circle"></i> Add Expectation
        </button>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Handle action type change to show/hide appropriate fields
        $(document).on('change', '.action-type', function () {
            var actionItem = $(this).closest('.action-item');
            var actionType = $(this).val();

            // Hide all field types
            actionItem.find('.goto-fields, .get_by_role-fields, .page_locator-fields').hide();

            // Show the selected field type
            actionItem.find('.' + actionType + '-fields').show();
        });

        // Handle role action type change
        $(document).on('change', '.role-action-type', function () {
            var actionItem = $(this).closest('.role-action-item');
            var actionType = $(this).val();

            // Hide all field types
            actionItem.find('.fill-fields, .press-fields').hide();

            // Show the selected field type (click has no fields)
            if (actionType !== 'click') {
                actionItem.find('.' + actionType + '-fields').show();
            }
        });

        // Handle expect condition change to enable/disable value field
        $(document).on('change', '.expect-condition', function () {
            var valueField = $(this).closest('.expect-item').find('.expect-value');
            if ($(this).val() === 'visible') {
                valueField.prop('disabled', true);
            } else {
                valueField.prop('disabled', false);
            }
        });

        // Add new block
        $('#add-block').click(function () {
            var newBlock = `
                <div class="card mb-4 test-block">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="input-group">
                            <span class="input-group-text">Block Name</span>
                            <input type="text" class="form-control block-name" value="New Block">
                        </div>
                        <button type="button" class="btn btn-danger remove-block"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="card-body">
                        <h5>Actions</h5>
                        <div class="actions-container">
                            <!-- Empty action container -->
                        </div>
                        <button type="button" class="btn btn-c2 add-action">
                            <i class="bi bi-plus-circle"></i> Add Action
                        </button>

                        <h5 class="mt-4">Expectations</h5>
                        <div class="expects-container">
                            <!-- Empty expects container -->
                        </div>
                        <button type="button" class="btn btn-c2 add-expect">
                            <i class="bi bi-plus-circle"></i> Add Expectation
                        </button>
                    </div>
                </div>
            `;
            $('#test-blocks-container').append(newBlock);
        });

        // Add new action
        $(document).on('click', '.add-action', function () {
            var actionsContainer = $(this).siblings('.actions-container');
            var newAction = `
                <div class="card mb-3 action-item">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <select class="form-control action-type">
                            <option value="goto" selected>goto</option>
                            <option value="get_by_role">get_by_role</option>
                            <option value="page_locator">page_locator</option>
                        </select>
                        <button type="button" class="btn btn-danger remove-action"><i class="bi bi-trash"></i></button>
                    </div>
                    <div class="card-body">
                        <!-- Dynamic fields based on action type -->
                        <div class="goto-fields">
                            <div class="form-group">
                                <label>URL</label>
                                <input type="text" class="form-control goto-url" value="">
                            </div>
                        </div>

                        <div class="get_by_role-fields" style="display: none;">
                            <div class="form-group mb-3">
                                <label>Role</label>
                                <input type="text" class="form-control get_by_role-role" value="">
                            </div>
                            <div class="form-group mb-3">
                                <label>Name</label>
                                <input type="text" class="form-control get_by_role-name" value="">
                            </div>

                            <h6>Role Actions</h6>
                            <div class="role-actions-container">
                                <!-- Empty role actions container -->
                            </div>
                            <button type="button" class="btn btn-sm btn-c2 add-role-action">
                                <i class="bi bi-plus-circle"></i> Add Role Action
                            </button>
                        </div>

                        <div class="page_locator-fields" style="display: none;">
                            <div class="form-group">
                                <label>Selector</label>
                                <input type="text" class="form-control page_locator-selector" value="">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            actionsContainer.append(newAction);
        });

        // Add new role action
        $(document).on('click', '.add-role-action', function () {
            var roleActionsContainer = $(this).siblings('.role-actions-container');
            var newRoleAction = `
                <div class="card mb-2 role-action-item">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <select class="form-control role-action-type">
                                <option value="click" selected>click</option>
                                <option value="fill">fill</option>
                                <option value="press">press</option>
                            </select>
                            <button type="button" class="btn btn-danger remove-role-action"><i class="bi bi-trash"></i></button>
                        </div>

                        <div class="fill-fields" style="display: none;">
                            <div class="form-group">
                                <label>Value</label>
                                <input type="text" class="form-control fill-value" value="">
                            </div>
                        </div>

                        <div class="press-fields" style="display: none;">
                            <div class="form-group">
                                <label>Key</label>
                                <input type="text" class="form-control press-key" value="">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            roleActionsContainer.append(newRoleAction);
        });

        // Add new expectation
        $(document).on('click', '.add-expect', function () {
            var expectsContainer = $(this).siblings('.expects-container');
            var newExpect = `
                <div class="row mb-3 expect-item">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Element Selector</label>
                            <input type="text" class="form-control expect-element" value="">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Condition</label>
                            <select class="form-control expect-condition">
                                <option value="visible" selected>Is Visible</option>
                                <option value="contains">Contains Text</option>
                                <option value="has_value">Has Value</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Value</label>
                            <input type="text" class="form-control expect-value" disabled>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Timeout (ms)</label>
                            <input type="number" class="form-control expect-timeout" value="5000">
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-expect mb-2"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
            expectsContainer.append(newExpect);
        });

        // Remove block
        $(document).on('click', '.remove-block', function () {
            // Don't remove if it's the last block
            if ($('.test-block').length > 1) {
                $(this).closest('.test-block').remove();
            } else {
                alert('You must have at least one test block.');
            }
        });

        // Remove action
        $(document).on('click', '.remove-action', function () {
            $(this).closest('.action-item').remove();
        });

        // Remove role action
        $(document).on('click', '.remove-role-action', function () {
            $(this).closest('.role-action-item').remove();
        });

        // Remove expectation
        $(document).on('click', '.remove-expect', function () {
            $(this).closest('.expect-item').remove();
        });
    });
</script>