{%- if field_value in ["paused","5","10","30","60","120",5,10,30,60,120] -%}
    {% set current_field_value = field_value %}
{% else %}
    {% set current_field_value = "paused" %}
{% endif %}

{% extends theme("explorer/files/fieldlayout_" + field_layout + ".html") %}

{% block content %}
    <div class="input-group clarama-field-timer">
        <span class="input-group-text"><i class="bi bi-stopwatch"></i></span>

        {# Preset options in seconds #}
        {% set presets = [
        {"label":"Paused","value":"paused"},
        {"label":"5 sec","value":5},
        {"label":"10 sec","value":10},
        {"label":"30 sec","value":30},
        {"label":"1 min","value":60},
        {"label":"2 min","value":120},
        {"label":"Custom","value":"custom"}
    ] %}

        {# Hidden input to keep the chosen preset value for form submission #}
        <input type="hidden"
               data-id="{{ field_id }}"
               name="{{ field_name }}_preset"
               class="clarama-field"
               fieldtype="html"
               data-sticky="true"
               value="{{ current_field_value }}">

        <div class="btn-group">
            <button type="button"
                    class="btn btn-outline-secondary dropdown-toggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    id="dropdown-{{ field_id }}">
            <span class="current-label">
                {% set current = (current_field_value|string) %}
                {% if current in ["paused","5","10","30","60","120"] %}
                    {% for p in presets %}{% if (p.value|string) == current %}{{ p.label }}{% endif %}{% endfor %}
                {% else %}Custom{% endif %}
            </span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdown-{{ field_id }}">
                {% for p in presets %}
                    {% if p.value != 'custom' %}
                        <li>
                            <a class="dropdown-item preset-item" href="#" data-value="{{ p.value }}">{{ p.label }}</a>
                        </li>
                    {% else %}
                        <li>
                            <input data-id="{{ field_id }}"
                                   name="{{ field_name }}"
                                   type="number"
                                   min="5"
                                   max="300"
                                   step="1"
                                   class="form-control custom-field clarama-field"
                                   fieldtype="html"
                                   data-sticky="true"
                                   placeholder="seconds (5-300)"
                                   value="{{ (field_value if field_value not in ['paused','5','10','30','60','120'] else field_value) or get(field_config,'default','') }}"
                                    {% include theme("explorer/files/field_tooltip.html") %}
                            />
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
    {# Log container for embed mode; will be shown only when embedded #}
    <div class="timer-event-log text-muted small mt-1" style="display:none;"></div>
    <script>
        // Initialise the dropdown using jQuery and add live timer behavior
        $(function () {
            function labelFor(val) {
                switch (String(val)) {
                    case 'paused': return 'Paused';
                    case '5': return '5 sec';
                    case '10': return '10 sec';
                    case '30': return '30 sec';
                    case '60': return '1 min';
                    case '120': return '2 min';
                    case 'custom': return 'Custom';
                    default: return 'Custom';
                }
            }

            function parseSeconds(val) {
                var n = parseInt(val);
                if (isNaN(n)) return null;
                if (n < 5) n = 5;
                if (n > 300) n = 300;
                return n;
            }

            function isEmbedded($el) {
                return $el.closest('.clarama-embedded, .clarama-post-embedded, [mode="embed"]').length > 0;
            }

            function setupTimer($container) {
                var $hiddenPreset = $container.find('input[type="hidden"].clarama-field');
                var $input = $container.find('input.custom-field');
                var $log = $container.closest('.clarama-field-timer').parent().find('.timer-event-log').first();

                function currentSeconds() {
                    var pv = $hiddenPreset.val();
                    if (pv === 'paused') return null;
                    if (pv === 'custom') return parseSeconds($input.val());
                    return parseSeconds(pv);
                }

                function clearTimer() {
                    var id = $container.data('claramaTimerId');
                    if (id) {
                        clearInterval(id);
                        $container.removeData('claramaTimerId');
                    }
                }

                function logTick(ts) {
                    if (!isEmbedded($container)) return;
                    // ensure log visible
                    $log.show();
                    var list = $log.data('ticks') || [];
                    list.unshift(ts);
                    list = list.slice(0, 4);
                    $log.data('ticks', list);
                    var html = '<div>Last events:</div>' +
                        '<ul class="mb-0">' + list.map(function (t) {
                            return '<li>' + t + '</li>'
                        }).join('') + '</ul>';
                    $log.html(html);
                }

                function startTimer() {
                    clearTimer();
                    var secs = currentSeconds();
                    if (!secs) return;
                    var interval = secs * 1000;
                    var id = setInterval(function () {
                        var payload = {
                            fieldId: $hiddenPreset.data('id') || '{{ field_id }}',
                            seconds: secs,
                            timestamp: new Date().toISOString(),
                            mode: isEmbedded($container) ? 'embed' : 'run'
                        };
                        // Fire a custom event on container and on document for broader listeners
                        $container.trigger('clarama:timer:tick', [payload]);
                        $(document).trigger('clarama:timer:tick', [payload]);
                        logTick(new Date().toLocaleString());
                    }, interval);
                    $container.data('claramaTimerId', id);
                }

                // initial start
                startTimer();

                // Restart when values change
                $hiddenPreset.on('change', function () {
                    startTimer();
                });
                $input.on('change input', function () {
                    if ($hiddenPreset.val() === 'custom') startTimer();
                });

                // When element is removed, clear interval
                $container.on('remove', function () {
                    clearTimer();
                });
            }

            // For each timer widget on the page
            $('.clarama-field-timer').each(function () {
                var $container = $(this);
                var $hiddenPreset = $container.find('input[type="hidden"].clarama-field');
                var $input = $container.find('input.custom-field');
                var $labelSpan = $container.find('.current-label');

                function syncFromPreset() {
                    var presetVal = $hiddenPreset.val();
                    $labelSpan.text(labelFor(presetVal));
                    if (presetVal === 'custom') {
                        $input.prop('readonly', false);
                    } else if (presetVal === 'paused') {
                        $input.val('');
                        $input.prop('readonly', true);
                    } else {
                        $input.val(presetVal);
                        $input.prop('readonly', true);
                    }
                }

                // Click handler for preset items
                $container.on('click', '.preset-item', function (e) {
                    e.preventDefault();
                    var val = $(this).data('value');
                    $hiddenPreset.val(String(val));
                    // trigger change in case listeners exist
                    $hiddenPreset.trigger('change');
                    syncFromPreset();
                });

                // Initialise
                syncFromPreset();
                setupTimer($container);

                setTimeout(syncFromPreset, 0);
                setTimeout(syncFromPreset, 300);
                setTimeout(syncFromPreset, 1000);

                // Show log only if embedded
                var $log = $container.closest('.clarama-field-timer').parent().find('.timer-event-log').first();
                if (isEmbedded($container)) {
                    $log.show().html('<div>Last events:</div><ul class="mb-0"></ul>');
                } else {
                    $log.hide();
                }
            });
        });
    </script>
{% endblock %}
